# 快速部署脚本更新日志

## 版本：v2.0 - 支持远程数据库环境（2025-01）

### 主要变更

#### 1. 新增交互式环境配置向导 ✨

- **自动检测首次部署**：脚本会检查 `.env` 文件是否存在
- **交互式配置引导**：友好地引导用户输入数据库连接信息
  - 数据库主机地址
  - 数据库端口
  - 数据库用户名
  - 数据库密码（隐藏输入）
  - 数据库名称
- **自动生成 .env 文件**：根据用户输入自动创建配置文件
- **配置摘要显示**：完成后显示配置概要（密码被隐藏）

#### 2. 移除本地数据库初始化步骤 🗑️

- 移除了 `npm run db:init` 命令调用
- 理由：
  - 该命令在 `package.json` 中不存在
  - TypeORM 会在应用启动时自动处理数据库连接和同步
  - 远程数据库环境不需要本地初始化

#### 3. 更新文件验证列表 📝

- 移除：`server/db/autotest.db`（本地 SQLite 文件）
- 新增：`.env`（环境变量配置文件）
- 更符合远程数据库的使用场景

#### 4. 优化成功提示信息 💡

**变更前：**
```
重置数据库：
  npm run db:reset
```

**变更后：**
```
修改数据库配置：
  编辑 .env 文件并重启服务
```

### 使用示例

```bash
# 在全新环境中运行
cd /path/to/automation-platform
bash deployment/scripts/setup.sh

# 脚本会提示：
╔════════════════════════════════════════════════════════════╗
║     自动化测试平台 - 快速部署脚本                          ║
╚════════════════════════════════════════════════════════════╝

[INFO] 检查 Node.js 环境...
[SUCCESS] Node.js 已安装: v20.10.0
[SUCCESS] 检测到项目文件

[INFO] 配置环境变量...
[INFO] 检测到这是首次配置，需要设置数据库连接信息

请输入数据库连接信息（按 Enter 使用默认值）：
════════════════════════════════════════════
数据库主机地址 [localhost]: 192.168.1.100
数据库端口 [3306]: 3306
数据库用户名 [root]: testuser
数据库密码: ********
数据库名称 [autotest]: autotest_db
════════════════════════════════════════════

[SUCCESS] .env 文件创建成功

[INFO] 配置摘要：
  数据库主机: 192.168.1.100
  数据库端口: 3306
  数据库名称: autotest_db
  数据库用户: testuser
  数据库密码: ********

[INFO] 安装项目依赖...
...
```

### 兼容性说明

- ✅ 首次部署：自动进入配置向导
- ✅ 已有 `.env` 文件：自动跳过配置，直接进入依赖安装
- ✅ macOS：使用 `sed -i ''` 语法
- ✅ Linux：使用 `sed -i` 语法
- ✅ 密码隐藏输入：使用 `read -s` 保护敏感信息

### 配置文件

新增了 `.env.example` 模板文件，包含完整的环境变量说明：
- 应用配置
- 数据库配置（必填）
- Jenkins 集成配置（可选）
- 日志配置
- 调度任务配置
- 邮件通知配置（可选）

### 迁移指南

#### 从旧版本迁移

如果您之前使用的是本地 SQLite 数据库，现在需要：

1. **准备远程数据库**
   - 确保 MariaDB/MySQL 服务正在运行
   - 创建目标数据库：`CREATE DATABASE autotest CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
   - 创建用户并授权

2. **重新运行部署脚本**
   ```bash
   # 删除旧的 .env 文件（如果存在）
   rm .env
   
   # 重新运行脚本
   bash deployment/scripts/setup.sh
   ```

3. **启动应用**
   ```bash
   npm run start
   ```
   
   TypeORM 会自动创建表结构（如果 `DB_SYNC=true`）

### 故障排查

#### Q: 提示 "DB_PASSWORD is required in production"

**原因**：生产环境必须设置数据库密码

**解决**：
```bash
# 编辑 .env 文件
nano .env

# 设置密码
DB_PASSWORD=your_secure_password

# 或者在开发环境中，设置环境为 development
NODE_ENV=development
```

#### Q: 数据库连接失败

**排查步骤**：
1. 检查数据库服务是否运行：`mysql -h <host> -P <port> -u <user> -p`
2. 检查防火墙规则是否允许连接
3. 验证 `.env` 中的配置是否正确
4. 查看应用日志获取详细错误信息

#### Q: sed 命令报错

**可能原因**：不同操作系统的 sed 语法不同

**解决**：脚本已自动处理 macOS 和 Linux 差异，如果仍有问题，请手动编辑 `.env` 文件

### 相关文档

- 📘 [快速开始指南](./QUICK_START.md)
- 📗 [完整安装指南](./INSTALLATION.md)
- 📙 [部署指南](./DEPLOYMENT.md)
- 📕 [项目说明](../README.md)

### 反馈与支持

如果您在使用过程中遇到问题，请：
1. 查看本文档的故障排查部分
2. 检查 `.env.example` 中的配置说明
3. 查看应用日志文件
4. 联系开发团队

---

**最后更新**：2025-01-20  
**维护者**：自动化测试平台开发团队
