# 快速开始 - Docker 部署

## 📖 核心概念

### 环境配置如何工作

```
┌─────────────────────────────────────────────────────┐
│  服务器文件系统                                      │
│                                                      │
│  /opt/automation-platform/                          │
│  ├── .env  ←──────────────┐                        │
│  │   DB_HOST=117.72.182.23 │  读取配置              │
│  │   DB_PORT=3306          │                        │
│  │   DB_PASSWORD=xxx       │                        │
│  │   JENKINS_URL=xxx       │                        │
│  │                          │                        │
│  └── deployment/            │                        │
│      └── docker-compose.yml │                        │
│          env_file:          │                        │
│            - ../.env ───────┘                        │
│                              ↓                        │
│  ┌────────────────────────────────────────────┐    │
│  │  Docker 容器                                │    │
│  │  ┌──────────────────────────────────────┐ │    │
│  │  │  环境变量 (运行时注入)               │ │    │
│  │  │  DB_HOST=117.72.182.23             │ │    │
│  │  │  DB_PORT=3306                       │ │    │
│  │  │  DB_PASSWORD=xxx                    │ │    │
│  │  │  JENKINS_URL=xxx                    │ │    │
│  │  └──────────────────────────────────────┘ │    │
│  │                ↓                            │    │
│  │  ┌──────────────────────────────────────┐ │    │
│  │  │  应用代码                             │ │    │
│  │  │  process.env.DB_HOST                │ │    │
│  │  │  → "117.72.182.23"                  │ │    │
│  │  └──────────────────────────────────────┘ │    │
│  └────────────────────────────────────────────┘    │
│                              ↓                        │
│  ┌────────────────────────────────────────────┐    │
│  │  外部 MariaDB 数据库                        │    │
│  │  117.72.182.23:3306                        │    │
│  └────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
```

### 关键点 ✅

1. **配置文件不打包到镜像** - `.env` 在服务器上，不在容器里
2. **启动时注入** - Docker Compose 读取 `.env` 并注入到容器
3. **应用读取** - 应用代码通过 `process.env.XXX` 读取
4. **修改生效** - 改 `.env` 后重启容器即可

## 🚀 三步部署

### 步骤 1: 准备配置文件

你的 `.env` 文件已经存在于项目根目录：

```bash
# 查看当前配置
cat .env

# 确认包含以下配置：
# ✅ DB_HOST=117.72.182.23
# ✅ DB_PORT=3306
# ✅ DB_USER=root
# ✅ DB_PASSWORD=Caijinwei2025
# ✅ DB_NAME=autotest
# ✅ JENKINS_URL=http://jenkins.wiac.xyz:8080
# ✅ JENKINS_TOKEN=...
```

### 步骤 2: 构建和启动

```bash
# 进入部署目录
cd deployment

# 构建镜像
docker build -t automation-platform:latest -f Dockerfile ..

# 启动容器（自动读取 ../.env）
docker-compose up -d

# 查看启动日志
docker-compose logs -f app
```

### 步骤 3: 验证配置

```bash
# 运行验证脚本
./scripts/verify-env.sh

# 或手动验证
docker exec automation-platform env | grep -E "DB_|JENKINS_"

# 测试应用
curl http://localhost:3000/api/health
```

## 🔧 常用操作

### 修改配置

```bash
# 1. 编辑 .env
vim ../.env

# 2. 重启容器（使新配置生效）
docker-compose restart app

# 3. 验证
docker exec automation-platform env | grep DB_HOST
```

### 查看日志

```bash
# 实时日志
docker-compose logs -f app

# 最近 100 行
docker logs --tail 100 automation-platform

# 过滤关键词
docker logs automation-platform 2>&1 | grep -i "database"
```

### 进入容器调试

```bash
# 进入容器
docker exec -it automation-platform sh

# 查看环境变量
printenv | grep DB_

# 测试数据库连接
apk add --no-cache mysql-client
mysql -h $DB_HOST -u $DB_USER -p$DB_PASSWORD -e "SELECT 1;"

# 退出容器
exit
```

### 停止和重启

```bash
# 停止
docker-compose down

# 启动
docker-compose up -d

# 重启
docker-compose restart app

# 重新创建容器
docker-compose up -d --force-recreate app
```

## 📊 配置文件说明

### .env 文件（项目根目录）

这是你的主配置文件，**不会被打包到镜像中**：

```bash
# 数据库配置（连接外部数据库）
DB_HOST=117.      # 你的远程数据库地址
DB_PORT=3306
DB_USER=root
DB_PASSWORD=
DB_NAME=autotest

# Jenkins 配置
JENKINS_URL=http://jenkins.wiac.xyz:8080
JENKINS_USER=root
JENKINS_TOKEN=116fb13c3cc6cd3

# JWT 配置
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d

# 其他配置...
```

### docker-compose.yml 文件

配置如何读取 `.env` 文件：

```yaml
services:
  app:
    # 方式1: 读取整个 .env 文件（推荐）
    env_file:
      - ../.env
    
    # 方式2: 单独指定变量（可选）
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - JENKINS_URL=${JENKINS_URL}
```

## ❓ 常见问题

### Q1: 容器能读取到 .env 吗？

**能！** Docker Compose 会在启动容器时读取 `.env` 文件，并将变量注入到容器的环境变量中。

验证方法：
```bash
docker exec automation-platform env | grep DB_HOST
# 输出: DB_HOST=117.72.182.23  ✅
```

### Q2: .env 会被打包到镜像吗？

**不会！** `.env` 文件在服务器上，不会被复制到镜像中。即使你把镜像分享给别人，他们也看不到你的配置。

验证方法：
```bash
# 查看镜像中的文件
docker run --rm automation-platform:latest ls -la /
# 不会看到 .env 文件 ✅
```

### Q3: 不同服务器可以用不同配置吗？

**可以！** 每个服务器维护自己的 `.env` 文件：

```bash
# 开发服务器
服务器A: /opt/automation-platform/.env
         DB_HOST=dev-db.example.com
         JENKINS_URL=http://dev-jenkins.com

# 生产服务器
服务器B: /opt/automation-platform/.env
         DB_HOST=prod-db.example.com
         JENKINS_URL=https://prod-jenkins.com
```

同一个镜像，不同的配置！

### Q4: 如何保护敏感信息？

```bash
# 1. 设置文件权限
chmod 600 .env

# 2. 不提交到 Git
echo ".env" >> .gitignore

# 3. 定期备份（但不要放在公开位置）
cp .env .env.backup
chmod 600 .env.backup

# 4. 生产环境考虑使用 Docker Secrets
```

## 🎯 部署检查清单

部署前确认：

- [ ] `.env` 文件存在于项目根目录
- [ ] 数据库配置正确（DB_HOST, DB_PORT, DB_USER, DB_PASSWORD）
- [ ] Jenkins 配置正确（如果使用）
- [ ] `.env` 文件权限设置为 600
- [ ] `.env` 已添加到 `.gitignore`
- [ ] Docker 和 Docker Compose 已安装

部署后验证：

- [ ] 容器成功启动 (`docker ps`)
- [ ] 容器能读取环境变量 (`./scripts/verify-env.sh`)
- [ ] 应用健康检查通过 (`curl http://localhost:3000/api/health`)
- [ ] 数据库连接成功（查看应用日志）
- [ ] Jenkins 集成正常（如果配置）

## 📞 获取帮助

### 查看详细文档

- [部署指南-读取外部环境配置.md](./部署指南-读取外部环境配置.md) - 详细说明
- [README.md](./README.md) - 完整部署指南
- [Docker部署-外部数据库连接指南.md](../docs/Docker部署-外部数据库连接指南.md) - 数据库连接

### 运行验证脚本

```bash
cd deployment
./scripts/verify-env.sh
```

### 查看日志

```bash
# 应用日志
docker logs -f automation-platform

# 系统日志
docker-compose logs -f
```

## 🎉 完成！

现在你的 Docker 容器已经配置好从外部读取环境配置了！

**核心优势：**
- ✅ 配置与代码分离
- ✅ 不同环境不同配置
- ✅ 敏感信息不会泄露
- ✅ 修改配置无需重新构建镜像
- ✅ 符合 12-Factor App 最佳实践
