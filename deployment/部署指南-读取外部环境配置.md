# Docker 容器读取外部环境配置指南

## 🎯 核心原理

容器可以通过以下方式读取容器外（宿主机）的环境配置：

1. **env_file** - 从宿主机的 `.env` 文件读取（推荐）
2. **environment** - 通过环境变量注入
3. **volumes** - 挂载配置文件到容器内
4. **Docker Secrets** - 生产环境敏感信息管理

## ✅ 当前配置（已完成）

你的项目已经配置好了从**外部 .env 文件**读取配置，配置文件在：

```
项目根目录/.env          # 你的配置文件（不会被打包到镜像）
```

### 工作流程

```
服务器上的 .env 文件
         ↓
  Docker Compose 读取
         ↓
   注入到容器的环境变量
         ↓
  应用代码读取 process.env.DB_HOST 等
```

## 📋 使用方法

### 方式1: 使用 env_file（推荐 ✅）

这是最简单的方式，已经在 `docker-compose.yml` 中配置好了：

```yaml
services:
  app:
    env_file:
      - ../.env  # 读取项目根目录的 .env 文件
```

**特点：**
- ✅ .env 文件中的所有变量都会自动注入到容器
- ✅ 不需要在 docker-compose.yml 中一个个列举
- ✅ 修改 .env 后重启容器即可生效
- ✅ .env 文件不会被打包到镜像中

### 方式2: 使用 environment（可选）

在 `docker-compose.yml` 中单独指定环境变量：

```yaml
services:
  app:
    environment:
      - DB_HOST=${DB_HOST}       # 从宿主机 .env 读取
      - DB_PORT=${DB_PORT}
      - DB_PASSWORD=${DB_PASSWORD}
```

**特点：**
- ✅ 可以覆盖 env_file 中的值
- ✅ 可以设置默认值：`${PORT:-3000}`
- ⚠️ 需要一个个列举变量

### 方式3: 挂载配置文件（高级用法）

如果你的配置是 JSON、YAML 等格式：

```yaml
services:
  app:
    volumes:
      - ../config.json:/app/config.json:ro  # 挂载配置文件（只读）
```

**特点：**
- ✅ 适合复杂的配置文件
- ✅ 支持热更新（有些应用可以监听文件变化）
- ⚠️ 需要应用代码支持读取文件

## 🚀 快速部署（服务器上）

### 步骤1: 准备服务器环境

```bash
# SSH 登录服务器
ssh user@your-server.com

# 克隆代码
cd /opt
git clone <your-repo-url> automation-platform
cd automation-platform
```

### 步骤2: 配置环境变量

```bash
# 编辑 .env 文件（已经存在）
vim .env

# 确保包含以下配置：
# DB_HOST=117.72.182.23
# DB_PORT=3306
# DB_USER=root
# DB_PASSWORD=Caijinwei2025
# DB_NAME=autotest
# JENKINS_URL=http://jenkins.wiac.xyz:8080
# ... 其他配置
```

### 步骤3: 构建和启动

```bash
# 进入部署目录
cd deployment

# 构建镜像
docker build -t automation-platform:latest -f Dockerfile ..

# 启动服务（会自动读取 ../.env 文件）
docker-compose up -d

# 查看日志
docker-compose logs -f app
```

### 步骤4: 验证配置是否生效

```bash
# 方式1: 查看容器环境变量
docker exec automation-platform env | grep DB_HOST

# 应该输出: DB_HOST=117.72.182.23

# 方式2: 进入容器检查
docker exec -it automation-platform sh
echo $DB_HOST
echo $JENKINS_URL
exit

# 方式3: 测试健康检查
curl http://localhost:3000/api/health
```

## 🔄 修改配置后如何更新

**重要：修改 .env 文件后，容器需要重启才能读取新配置**

```bash
# 方式1: 重启容器（快速，推荐）
docker-compose restart app

# 方式2: 停止并重新创建容器
docker-compose down
docker-compose up -d

# 方式3: 使用部署脚本
./deploy.sh -m basic
```

## 📊 三种方式对比

| 方式 | 配置位置 | 修改后生效 | 安全性 | 推荐度 |
|------|---------|-----------|--------|--------|
| **env_file** | 服务器 `.env` 文件 | 重启容器 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **environment** | `docker-compose.yml` | 重启容器 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **volumes** | 挂载配置文件 | 立即生效（需应用支持） | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **硬编码在镜像** | Dockerfile | 重新构建镜像 | ⭐ | ❌ 不推荐 |

## 🔐 安全最佳实践

### 1. 保护 .env 文件

```bash
# 设置文件权限（只有所有者可读写）
chmod 600 .env

# 确认权限
ls -la .env
# 应该显示: -rw------- 1 user user 1234 Feb 01 10:00 .env
```

### 2. 不要提交到 Git

```bash
# 检查 .gitignore
cat ../.gitignore | grep .env

# 如果没有，添加
echo ".env" >> ../.gitignore
```

### 3. 使用 Docker Secrets（生产环境推荐）

对于敏感信息（如数据库密码），生产环境可以使用 Docker Secrets：

```bash
# 创建 secret
echo "Caijinwei2025" | docker secret create db_password -

# 在 docker-compose.yml 中使用
services:
  app:
    secrets:
      - db_password
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password

secrets:
  db_password:
    external: true
```

## 🛠️ 常见问题

### Q1: 容器无法读取 .env 文件？

**检查路径：**
```bash
# 确保路径正确（相对于 docker-compose.yml 的位置）
cd deployment
ls -la ../.env  # 应该能看到文件
```

**检查语法：**
```bash
# .env 文件格式
DB_HOST=117.72.182.23    # ✅ 正确
DB_HOST = 117.72.182.23  # ❌ 错误（有空格）
DB_HOST="117.72.182.23"  # ✅ 可以（但引号会被包含）
```

### Q2: 修改 .env 后不生效？

```bash
# 必须重启容器
docker-compose restart app

# 或者重新创建容器
docker-compose up -d --force-recreate app
```

### Q3: 如何查看容器内的环境变量？

```bash
# 查看所有环境变量
docker exec automation-platform env

# 查看特定变量
docker exec automation-platform env | grep DB_

# 进入容器交互式查看
docker exec -it automation-platform sh
printenv | grep DB_
```

### Q4: 生产环境和开发环境使用不同配置？

**方式1: 使用不同的 .env 文件**
```bash
# 开发环境
docker-compose --env-file ../.env.dev up -d

# 生产环境
docker-compose --env-file ../.env.prod up -d
```

**方式2: 在服务器上维护 .env**
```bash
# 每个环境有自己的 .env
服务器A: /opt/automation-platform/.env  # 开发环境配置
服务器B: /opt/automation-platform/.env  # 生产环境配置
```

## 📝 实际示例

### 你当前的配置流程

```bash
# 1. 服务器上的 .env 文件（已有）
cat /opt/automation-platform/.env
# DB_HOST=117.72.182.23
# DB_PORT=3306
# DB_USER=root
# DB_PASSWORD=Caijinwei2025
# ...

# 2. docker-compose.yml 配置（已更新）
cat /opt/automation-platform/deployment/docker-compose.yml
# services:
#   app:
#     env_file:
#       - ../.env  # 读取上面的文件

# 3. 应用代码读取（已有）
# server/config/database.ts:
# const dbConfig = {
#   host: process.env.DB_HOST,  # 读取容器的环境变量
#   port: process.env.DB_PORT,
#   ...
# };

# 4. 启动容器
cd /opt/automation-platform/deployment
docker-compose up -d

# 5. 验证
docker exec automation-platform env | grep DB_HOST
# 输出: DB_HOST=117.72.182.23  ✅ 成功！
```

## 🎉 总结

### ✅ 你的配置已经完成

- ✅ `.env` 文件在服务器上（不在镜像里）
- ✅ `docker-compose.yml` 配置了 `env_file: - ../.env`
- ✅ 容器启动时会自动读取 `.env` 的所有变量
- ✅ 应用代码使用 `process.env.DB_HOST` 读取配置

### 🚀 下一步操作

```bash
# 1. 进入部署目录
cd /opt/automation-platform/deployment

# 2. 启动容器（会自动读取 ../.env）
docker-compose up -d

# 3. 查看日志确认连接成功
docker-compose logs -f app

# 4. 测试应用
curl http://localhost:3000/api/health
```

### 🔑 关键优势

- **灵活性** - 不同服务器可以有不同的 .env 配置
- **安全性** - 敏感信息不会被打包到镜像中
- **易维护** - 修改配置只需编辑 .env 并重启容器
- **标准化** - 符合 Docker 和 12-Factor App 最佳实践

### ⚠️ 重要提醒

1. **修改 .env 后必须重启容器**
2. **不要把 .env 提交到 Git**
3. **生产环境使用强密码**
4. **定期备份 .env 文件**
