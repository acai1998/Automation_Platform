# ═══════════════════════════════════════════════════════════════════════════
# 自动化测试平台 - 环境变量配置示例
# ═══════════════════════════════════════════════════════════════════════════
# 说明：复制此文件为 .env，然后填入实际的值
# 重要：.env 文件包含敏感信息，不应提交到版本控制！
# ═══════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# 1. 应用基本配置
# ─────────────────────────────────────────────────────────────────────────────

# 应用运行环境：development | staging | production
NODE_ENV=development

# 应用监听端口（后端）
PORT=3000

# 数据库配置（如需）
DATABASE_URL=

# ─────────────────────────────────────────────────────────────────────────────
# 2. Jenkins 配置（必需）
# ─────────────────────────────────────────────────────────────────────────────

# Jenkins 服务器地址
# 示例：http://jenkins.wiac.xyz:8080/
#      http://localhost:8080/
#      https://jenkins.company.com/
JENKINS_URL=http://jenkins.wiac.xyz:8080/

# Jenkins 用户名（用于 Jenkins API 认证）
JENKINS_USER=root

# Jenkins API Token（从 Jenkins 个人设置页面生成）
# 步骤：Jenkins → 用户 → 配置 → API Token → 生成
JENKINS_TOKEN=116fb13c3cc6cd3e33e688bacc26e18b60

# Jenkins Job 配置（可选，如果使用默认名称可不改）
JENKINS_JOB_API=api-automation
JENKINS_JOB_UI=ui-automation
JENKINS_JOB_PERF=performance-automation

# Jenkins 回调 URL
# 此 URL 用于 Jenkins 在执行完成后回调本平台
# 示例：http://platform.example.com/api/jenkins/callback
#      http://localhost:3000/api/jenkins/callback
API_CALLBACK_URL=http://localhost:3000/api/jenkins/callback

# ─────────────────────────────────────────────────────────────────────────────
# 3. Jenkins 认证配置（必需）
# ─────────────────────────────────────────────────────────────────────────────
# 注意：应用需要以下三个环境变量来完成启动。如果缺失任何一个，应用将报错。

# API Key（用于回调认证方式1：API Key）
# 建议生成一个强密钥，例如：
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JENKINS_API_KEY=your-secret-api-key-here-min-8-chars

# JWT Secret（用于回调认证方式2：JWT Token）
# 建议使用强密钥
JENKINS_JWT_SECRET=your-secret-jwt-key-here-min-8-chars

# Signature Secret（用于回调认证方式3：HMAC-SHA256 签名）
# 建议使用强密钥
JENKINS_SIGNATURE_SECRET=your-secret-signature-key-here-min-8-chars

# ─────────────────────────────────────────────────────────────────────────────
# 4. IP 白名单配置（可选）
# ─────────────────────────────────────────────────────────────────────────────
# 说明：
#   - 留空：允许任何 IP 访问
#   - 精确 IP：192.168.1.100,10.0.0.5
#   - CIDR 网段：192.168.1.0/24,10.0.0.0/8
#   - localhost：localhost（自动识别 127.0.0.1, ::1）
#   - 混合：192.168.1.0/24,10.0.0.5,localhost
#
# 推荐配置：只允许 Jenkins 服务器 IP 或内网网段
# 示例：JENKINS_ALLOWED_IPS=192.168.1.100,10.0.0.0/24,localhost

JENKINS_ALLOWED_IPS=

# ─────────────────────────────────────────────────────────────────────────────
# 5. 调试配置（可选）
# ─────────────────────────────────────────────────────────────────────────────

# 启用 IP 地址识别调试日志
# 当设置为 'true' 时，会在开发环境中记录 IP 识别过程的详细信息
JENKINS_DEBUG_IP=false

# 启用详细日志
DEBUG=false

# ============== 邮件通知配置（可选）==============

# SMTP 服务器地址
SMTP_HOST=

# SMTP 端口
SMTP_PORT=587

# SMTP 用户名
SMTP_USER=

# SMTP 密码
SMTP_PASSWORD=

# 发件人邮箱
EMAIL_FROM=

# ═══════════════════════════════════════════════════════════════════════════
# 快速开始步骤
# ═══════════════════════════════════════════════════════════════════════════
#
# 1. 复制此文件：
#    cp .env.example .env
#
# 2. 编辑 .env 文件，填入实际的配置值：
#    - 必填：JENKINS_API_KEY, JENKINS_JWT_SECRET, JENKINS_SIGNATURE_SECRET
#    - 可选：JENKINS_ALLOWED_IPS, 其他 Jenkins 配置
#
# 3. 验证配置（启动前）：
#    npm run check-env
#
# 4. 启动应用：
#    npm run start
#
# 5. 测试回调连接：
#    curl -X POST http://localhost:3000/api/jenkins/callback/test \
#      -H "X-Api-Key: your-secret-api-key-here" \
#      -H "Content-Type: application/json" \
#      -d '{"testMessage": "hello"}'
#
# 6. 如果收到成功响应，说明配置正确！
#
# ═══════════════════════════════════════════════════════════════════════════
# Hybrid Sync Service Configuration (Optimized Callback and Polling Strategy)
# ═══════════════════════════════════════════════════════════════════════════
# Callback timeout (milliseconds) - switch to API polling if no callback received
# Default: 20000 = 20s (optimized for intranet, reduced from 30s)
# Valid range: 5000-60000 (5s-60s)
CALLBACK_TIMEOUT=20000

# Enable adaptive polling (dynamic intervals based on attempt number)
# Default: true - uses tiered polling: fast (5s) → normal (10s) → slow (15s)
# Set to false to use fixed POLL_INTERVAL
ADAPTIVE_POLLING_ENABLED=true

# Fast polling interval (milliseconds) - for initial attempts (1-3)
# Default: 5000 = 5s (quick detection for fast-completing jobs)
# Valid range: 1000-30000 (1s-30s)
POLL_INTERVAL_FAST=5000

# Fast polling attempts - number of attempts using fast interval
# Default: 3 (15 seconds total at 5s interval)
FAST_POLL_ATTEMPTS=3

# Normal polling interval (milliseconds) - for mid-range attempts (4-8)
# Default: 10000 = 10s (balanced Jenkins load)
# Valid range: 1000-60000 (1s-60s)
POLL_INTERVAL_NORMAL=10000

# Normal polling attempts - number of attempts using normal interval
# Default: 5 (50 seconds total at 10s interval)
NORMAL_POLL_ATTEMPTS=5

# Slow polling interval (milliseconds) - for later attempts (9+)
# Default: 15000 = 15s (reduced Jenkins load for long-running jobs)
# Valid range: 1000-120000 (1s-2min)
POLL_INTERVAL_SLOW=15000

# Maximum polling attempts - mark as timeout after this many attempts
# Default: 42 (adaptive: 3×5s + 5×10s + 34×15s = 15s + 50s + 510s ≈ 9.6 min total)
# Note: If ADAPTIVE_POLLING_ENABLED=false, uses POLL_INTERVAL_NORMAL for all attempts
MAX_POLL_ATTEMPTS=42

# Consistency check interval (milliseconds) - periodic status verification
# Default: 300000 = 5 minutes
# Valid range: 60000-3600000 (1min-1hour)
CONSISTENCY_CHECK_INTERVAL=300000

# ═══════════════════════════════════════════════════════════════════════════
# Execution Monitor Configuration (Optimized Quick-Fail Detection)
# ═══════════════════════════════════════════════════════════════════════════
# Enable execution monitor service (detects stuck executions, e.g., Jenkins compilation failures)
# Default: true
EXECUTION_MONITOR_ENABLED=true

# Monitor check interval (milliseconds) - frequency of stuck execution detection
# Default: 20000 = 20s (optimized from 30s for faster detection)
# Recommended: 20000 (20s) - balanced performance and responsiveness
# Fast detection: 15000 (15s) - faster but higher CPU usage (use only if necessary)
# Valid range: 5000-300000 (5s-5min)
EXECUTION_MONITOR_INTERVAL=20000

# Compilation check window (milliseconds) - time window for quick-fail detection
# Description: pending/running executions older than this will be checked
# Default: 20000 = 20s (optimized from 30s for faster compilation error detection)
# Valid range: 10000-300000 (10s-5min)
COMPILATION_CHECK_WINDOW=20000

# Maximum executions per batch
# Description: max number of executions to process per monitoring cycle
# Default: 20
# Valid range: 1-100
EXECUTION_MONITOR_BATCH_SIZE=20

# Jenkins API call rate limit (milliseconds)
# Description: delay between Jenkins API calls to prevent overwhelming Jenkins
# Default: 100ms
# Valid range: 0-5000 (0s-5s)
EXECUTION_MONITOR_RATE_LIMIT=100

# Quick-fail threshold (seconds)
# Description: executions failing faster than this are considered quick-fails (compilation/config errors)
# Default: 20s (optimized from 30s for faster alert)
# Valid range: 5-300 (5s-5min)
QUICK_FAIL_THRESHOLD_SECONDS=20

# Early stuck threshold (seconds) - NEW
# Description: alert users when execution is stuck for this duration (early warning)
# Default: 120s = 2 minutes (early detection for configuration issues)
# Valid range: 30-600 (30s-10min)
EARLY_STUCK_THRESHOLD_SECONDS=120

# Stuck threshold (seconds) - for critical alerts
# Description: critical alert when execution is stuck for this duration
# Default: 300s = 5 minutes (maintained for critical alerts)
# Valid range: 60-1800 (1min-30min)
STUCK_THRESHOLD_SECONDS=300

# Monitor max age (hours) - only check recent executions
# Description: only monitor executions created within this time window
# Default: 24 hours (avoids querying old executions, reduces DB load)
EXECUTION_MONITOR_MAX_AGE_HOURS=24

# Cleanup interval (milliseconds) - frequency of old execution cleanup
# Description: mark executions older than EXECUTION_MONITOR_MAX_AGE_HOURS as aborted
# Default: 3600000 = 1 hour
EXECUTION_CLEANUP_INTERVAL=3600000

# ═══════════════════════════════════════════════════════════════════════════
# WebSocket Configuration (Real-time Status Push)
# ═══════════════════════════════════════════════════════════════════════════
# Enable WebSocket service
# Default: true - enables real-time push notifications with < 1s latency
WEBSOCKET_ENABLED=true

# WebSocket path
# Default: /api/ws
WEBSOCKET_PATH=/api/ws

# Frontend URL (for CORS configuration)
# Examples: http://localhost:5173 (development)
#          https://platform.company.com (production)
FRONTEND_URL=http://localhost:5173

# WebSocket ping timeout (milliseconds)
# Description: close connection if no pong received within this time
# Default: 60000 = 60s
# Valid range: 10000-300000 (10s-5min)
WEBSOCKET_PING_TIMEOUT=60000

# WebSocket ping interval (milliseconds)
# Description: send ping to client at this interval
# Default: 25000 = 25s
# Valid range: 5000-120000 (5s-2min)
WEBSOCKET_PING_INTERVAL=25000

# WebSocket health check interval (milliseconds) - NEW
# Description: internal health check frequency
# Default: 30000 = 30s
# Valid range: 10000-300000 (10s-5min)
WEBSOCKET_HEALTH_CHECK_INTERVAL=30000

# WebSocket max retry attempts - NEW
# Description: maximum reconnection attempts before giving up
# Default: 5
WEBSOCKET_MAX_RETRY_ATTEMPTS=5

# WebSocket initial retry delay (milliseconds) - NEW
# Description: initial delay before first reconnection attempt
# Default: 1000 = 1s
WEBSOCKET_INITIAL_RETRY_DELAY=1000

# WebSocket max retry delay (milliseconds) - NEW
# Description: maximum delay between reconnection attempts (with exponential backoff)
# Default: 30000 = 30s
WEBSOCKET_MAX_RETRY_DELAY=30000

# ═══════════════════════════════════════════════════════════════════════════
# 需要帮助？
# ═══════════════════════════════════════════════════════════════════════════
#
# 详细配置指南：docs/JENKINS_AUTH_QUICK_START.md
# 常见问题：docs/JENKINS_AUTH_QUICK_START.md#常见问题
# 诊断工具：POST /api/jenkins/callback/diagnose
# 健康检查：GET /api/jenkins/health
# 监控状态：GET /api/jenkins/monitor/status
#
# ═══════════════════════════════════════════════════════════════════════════
