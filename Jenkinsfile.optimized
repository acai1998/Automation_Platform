// ==================== é…ç½®å¸¸é‡ ====================
@Library('shared-pipeline-library') _

def CONFIG = [
    // å¹³å°é…ç½®
    platformUrl: env.PLATFORM_API_URL ?: 'http://localhost:3000',
    apiKey: env.JENKINS_API_KEY ?: '',

    // Python ç¯å¢ƒ
    pythonVersion: '3.9',
    virtualEnvPath: "${WORKSPACE}/venv",

    // æµ‹è¯•é…ç½®
    testCaseDir: 'test-cases',
    reportFile: 'test-report.json',
    junitFile: 'junit.xml',

    // Docker é…ç½®
    dockerRegistry: 'crpi-dytkl1o45qyeksph.cn-hangzhou.personal.cr.aliyuncs.com',
    dockerRepo: 'caijinwei/auto_test',

    // é‡è¯•é…ç½®
    maxRetries: 3,
    retryDelay: 5
]

// ==================== Pipeline å®šä¹‰ ====================
pipeline {
    agent any

    // ==================== å‚æ•°å®šä¹‰ ====================
    parameters {
        string(
            name: 'RUN_ID',
            description: 'æ‰§è¡Œæ‰¹æ¬¡ID',
            defaultValue: ''
        )
        string(
            name: 'CASE_IDS',
            description: 'ç”¨ä¾‹IDåˆ—è¡¨(JSONæ•°ç»„)',
            defaultValue: '[]'
        )
        string(
            name: 'SCRIPT_PATHS',
            description: 'è„šæœ¬è·¯å¾„(é€—å·åˆ†éš”,æ”¯æŒpytestæ ¼å¼)',
            defaultValue: ''
        )
        string(
            name: 'CALLBACK_URL',
            description: 'å›è°ƒURL(å¯é€‰,é»˜è®¤ä½¿ç”¨å¹³å°URL)',
            defaultValue: ''
        )
        string(
            name: 'MARKER',
            description: 'Pytest markeræ ‡è®°(å¯é€‰)',
            defaultValue: ''
        )
        string(
            name: 'REPO_URL',
            description: 'æµ‹è¯•ç”¨ä¾‹ä»“åº“URL(å¯é€‰)',
            defaultValue: ''
        )
        string(
            name: 'REPO_BRANCH',
            description: 'ä»“åº“åˆ†æ”¯(é»˜è®¤main)',
            defaultValue: 'main'
        )
        choice(
            name: 'PYTHON_VERSION',
            choices: ['3.9', '3.10', '3.11'],
            description: 'Pythonç‰ˆæœ¬'
        )
        booleanParam(
            name: 'ENABLE_PARALLEL',
            defaultValue: false,
            description: 'å¯ç”¨å¹¶è¡Œæ‰§è¡Œ(ä»…é€‚ç”¨äºå¤šç”¨ä¾‹)'
        )
        booleanParam(
            name: 'BUILD_DOCKER_IMAGE',
            defaultValue: false,
            description: 'æ„å»ºå¹¶æ¨é€Dockeré•œåƒ'
        )
        booleanParam(
            name: 'SKIP_CLEANUP',
            defaultValue: false,
            description: 'è·³è¿‡æ¸…ç†æ­¥éª¤(ç”¨äºè°ƒè¯•)'
        )
    }

    // ==================== ç¯å¢ƒå˜é‡ ====================
    environment {
        // å¹³å°é…ç½®
        PLATFORM_API_URL = "${CONFIG.platformUrl}"
        JENKINS_API_KEY = credentials('jenkins-api-key')

        // Git å‡­æ®
        GIT_CREDENTIALS = credentials('git-credentials')

        // Docker å‡­æ®
        DOCKER_CREDENTIALS = credentials('aliyun-docker')

        // Python ç¯å¢ƒ
        PYTHON_ENV = "${CONFIG.virtualEnvPath}"
        PYTHONUNBUFFERED = '1'

        // æµ‹è¯•ç›®å½•
        TEST_CASE_DIR = "${CONFIG.testCaseDir}"

        // æ—¶é—´æˆ³
        BUILD_TIMESTAMP = sh(script: 'date +%s%3N', returnStdout: true).trim()
    }

    // ==================== é€‰é¡¹é…ç½® ====================
    options {
        // ä¿ç•™æ„å»ºå†å²
        buildDiscarder(logRotator(numToKeepStr: '30', daysToKeepStr: '30'))

        // è¶…æ—¶è®¾ç½®
        timeout(time: 2, unit: 'HOURS')

        // å¹¶å‘æ„å»ºé™åˆ¶
        disableConcurrentBuilds()

        // æ—¶é—´æˆ³
        timestamps()

        // ANSI é¢œè‰²è¾“å‡º
        ansiColor('xterm')
    }

    // ==================== é˜¶æ®µå®šä¹‰ ====================
    stages {
        // ==================== 1. åˆå§‹åŒ– ====================
        stage('åˆå§‹åŒ–') {
            steps {
                script {
                    // æ‰“å°æ„å»ºä¿¡æ¯
                    printBuildInfo()

                    // éªŒè¯å‚æ•°
                    validateParameters()

                    // é€šçŸ¥å¹³å°æ‰§è¡Œå¼€å§‹
                    if (params.RUN_ID) {
                        notifyPlatform('start', [runId: params.RUN_ID])
                    }
                }
            }
        }

        // ==================== 2. æ£€å‡ºä»£ç  ====================
        stage('æ£€å‡ºä»£ç ') {
            steps {
                script {
                    checkoutTestCode()
                }
            }
        }

        // ==================== 3. å‡†å¤‡ç¯å¢ƒ ====================
        stage('å‡†å¤‡ç¯å¢ƒ') {
            steps {
                script {
                    setupPythonEnvironment()
                }
            }
        }

        // ==================== 4. æ‰§è¡Œæµ‹è¯• ====================
        stage('æ‰§è¡Œæµ‹è¯•') {
            steps {
                script {
                    def testResults = executeTests()
                    env.TEST_RESULTS = writeJSON(returnText: true, json: testResults)
                }
            }
        }

        // ==================== 5. æ”¶é›†ç»“æœ ====================
        stage('æ”¶é›†ç»“æœ') {
            steps {
                script {
                    def results = collectTestResults()
                    env.COLLECTED_RESULTS = writeJSON(returnText: true, json: results)
                }
            }
        }

        // ==================== 6. å›è°ƒå¹³å° ====================
        stage('å›è°ƒå¹³å°') {
            steps {
                script {
                    def results = readJSON(text: env.COLLECTED_RESULTS)
                    notifyPlatform('complete', results)
                }
            }
        }

        // ==================== 7. æ„å»ºé•œåƒ(å¯é€‰) ====================
        stage('æ„å»ºé•œåƒ') {
            when {
                expression {
                    return params.BUILD_DOCKER_IMAGE && currentBuild.result == null
                }
            }
            steps {
                script {
                    buildAndPushDockerImage()
                }
            }
        }
    }

    // ==================== åå¤„ç† ====================
    post {
        always {
            script {
                // å½’æ¡£æµ‹è¯•æŠ¥å‘Š
                archiveTestReports()

                // æœ€ç»ˆå›è°ƒ(ç¡®ä¿çŠ¶æ€åŒæ­¥)
                finalCallback()

                // æ¸…ç†ç¯å¢ƒ
                if (!params.SKIP_CLEANUP) {
                    cleanup()
                }
            }
        }

        success {
            script {
                echo "âœ… Pipelineæ‰§è¡ŒæˆåŠŸ"
                sendNotification('success')
            }
        }

        failure {
            script {
                echo "âŒ Pipelineæ‰§è¡Œå¤±è´¥"
                sendNotification('failure')

                // ç¡®ä¿å¤±è´¥çŠ¶æ€å›è°ƒ
                if (params.RUN_ID) {
                    notifyPlatform('failed', [
                        runId: params.RUN_ID,
                        status: 'failed',
                        errorMessage: "Pipelineæ‰§è¡Œå¤±è´¥: ${currentBuild.result}"
                    ])
                }
            }
        }

        unstable {
            script {
                echo "âš ï¸ Pipelineæ‰§è¡Œä¸ç¨³å®š"
                sendNotification('unstable')
            }
        }

        aborted {
            script {
                echo "ğŸ›‘ Pipelineè¢«ä¸­æ­¢"
                if (params.RUN_ID) {
                    notifyPlatform('aborted', [
                        runId: params.RUN_ID,
                        status: 'aborted'
                    ])
                }
            }
        }
    }
}

// ==================== è¾…åŠ©å‡½æ•° ====================

/**
 * æ‰“å°æ„å»ºä¿¡æ¯
 */
def printBuildInfo() {
    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      æ„å»ºä¿¡æ¯                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ æ„å»ºç¼–å·: ${BUILD_NUMBER}
â•‘ è¿è¡ŒID: ${params.RUN_ID ?: 'æœªæŒ‡å®š'}
â•‘ ç”¨ä¾‹IDs: ${params.CASE_IDS}
â•‘ è„šæœ¬è·¯å¾„: ${params.SCRIPT_PATHS ?: 'æœªæŒ‡å®š'}
â•‘ Marker: ${params.MARKER ?: 'æœªæŒ‡å®š'}
â•‘ ä»“åº“URL: ${params.REPO_URL ?: 'æœªæŒ‡å®š'}
â•‘ ä»“åº“åˆ†æ”¯: ${params.REPO_BRANCH}
â•‘ Pythonç‰ˆæœ¬: ${params.PYTHON_VERSION}
â•‘ å¹¶è¡Œæ‰§è¡Œ: ${params.ENABLE_PARALLEL}
â•‘ æ„å»ºé•œåƒ: ${params.BUILD_DOCKER_IMAGE}
â•‘ å›è°ƒåœ°å€: ${params.CALLBACK_URL ?: CONFIG.platformUrl + '/api/jenkins/callback'}
â•‘ æ„å»ºæ—¶é—´: ${new Date()}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
}

/**
 * éªŒè¯å‚æ•°
 */
def validateParameters() {
    echo "ğŸ” éªŒè¯å‚æ•°..."

    def errors = []

    // éªŒè¯ RUN_ID
    if (!params.RUN_ID || params.RUN_ID.trim() == '') {
        errors.add("RUN_ID ä¸èƒ½ä¸ºç©º")
    }

    // éªŒè¯æ‰§è¡Œæ–¹å¼(è‡³å°‘æŒ‡å®šä¸€ç§)
    if (!params.SCRIPT_PATHS && !params.MARKER) {
        errors.add("å¿…é¡»æŒ‡å®š SCRIPT_PATHS æˆ– MARKER ä¹‹ä¸€")
    }

    // å¦‚æœæœ‰é”™è¯¯,æŠ›å‡ºå¼‚å¸¸
    if (errors.size() > 0) {
        error("å‚æ•°éªŒè¯å¤±è´¥:\n" + errors.join("\n"))
    }

    echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"
}

/**
 * æ£€å‡ºæµ‹è¯•ä»£ç 
 */
def checkoutTestCode() {
    echo "ğŸ“¦ æ£€å‡ºæµ‹è¯•ä»£ç ..."

    if (params.REPO_URL && params.REPO_URL.trim() != '') {
        dir(CONFIG.testCaseDir) {
            if (fileExists('.git')) {
                echo "æ›´æ–°ç°æœ‰ä»“åº“..."
                sh """
                    git fetch origin
                    git checkout ${params.REPO_BRANCH}
                    git pull origin ${params.REPO_BRANCH}
                """
            } else {
                echo "å…‹éš†æ–°ä»“åº“..."
                sh """
                    git clone -b ${params.REPO_BRANCH} ${params.REPO_URL} .
                """
            }
        }
    } else {
        echo "âš ï¸ æœªæŒ‡å®šä»“åº“URL,ä½¿ç”¨é»˜è®¤æµ‹è¯•ç”¨ä¾‹ç›®å½•"

        // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
        if (!fileExists(CONFIG.testCaseDir)) {
            error("æµ‹è¯•ç”¨ä¾‹ç›®å½•ä¸å­˜åœ¨: ${CONFIG.testCaseDir}")
        }
    }

    echo "âœ… ä»£ç æ£€å‡ºå®Œæˆ"
}

/**
 * å‡†å¤‡ Python ç¯å¢ƒ
 */
def setupPythonEnvironment() {
    echo "ğŸ å‡†å¤‡Pythonç¯å¢ƒ..."

    dir(CONFIG.testCaseDir) {
        retry(CONFIG.maxRetries) {
            sh """
                # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
                if [ ! -d "${PYTHON_ENV}" ]; then
                    echo "åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
                    python${params.PYTHON_VERSION} -m venv ${PYTHON_ENV}
                fi

                # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
                source ${PYTHON_ENV}/bin/activate

                # å‡çº§ pip
                python -m pip install --upgrade pip setuptools wheel -q

                # å®‰è£…æµ‹è¯•ä¾èµ–
                if [ -f "requirements.txt" ]; then
                    echo "å®‰è£… requirements.txt ä¾èµ–..."
                    pip install -r requirements.txt -q
                else
                    echo "å®‰è£…é»˜è®¤æµ‹è¯•ä¾èµ–..."
                    pip install pytest pytest-json-report pytest-html pytest-xdist -q
                fi

                # éªŒè¯å®‰è£…
                python --version
                pip list | grep pytest

                # åˆ—å‡ºå¯ç”¨æµ‹è¯•æ–‡ä»¶
                echo ""
                echo "å¯ç”¨çš„æµ‹è¯•æ–‡ä»¶(å‰20ä¸ª):"
                find . -type f \\( -name "test_*.py" -o -name "*_test.py" \\) | head -20
            """
        }
    }

    echo "âœ… Pythonç¯å¢ƒå‡†å¤‡å®Œæˆ"
}

/**
 * æ‰§è¡Œæµ‹è¯•
 */
def executeTests() {
    echo "ğŸ§ª æ‰§è¡Œæµ‹è¯•..."

    def startTime = System.currentTimeMillis()
    def testCommand = buildTestCommand()
    def exitCode = 0

    dir(CONFIG.testCaseDir) {
        sh """
            source ${PYTHON_ENV}/bin/activate

            echo "æ‰§è¡Œå‘½ä»¤: ${testCommand}"
            echo ""

            ${testCommand} || EXIT_CODE=\$?

            echo ""
            echo "æµ‹è¯•æ‰§è¡Œå®Œæˆ,é€€å‡ºç : \${EXIT_CODE:-0}"

            exit \${EXIT_CODE:-0}
        """

        exitCode = sh(script: 'echo $?', returnStatus: true)
    }

    def endTime = System.currentTimeMillis()
    def duration = endTime - startTime

    echo "âœ… æµ‹è¯•æ‰§è¡Œå®Œæˆ,è€—æ—¶: ${duration}ms"

    return [
        exitCode: exitCode,
        duration: duration,
        success: exitCode == 0
    ]
}

/**
 * æ„å»ºæµ‹è¯•å‘½ä»¤
 */
def buildTestCommand() {
    def command = "pytest"

    // æ·»åŠ è„šæœ¬è·¯å¾„
    if (params.SCRIPT_PATHS && params.SCRIPT_PATHS.trim() != '') {
        def paths = params.SCRIPT_PATHS.split(',').collect { it.trim() }
        command += " " + paths.join(' ')
    }

    // æ·»åŠ  marker
    if (params.MARKER && params.MARKER.trim() != '') {
        command += " -m ${params.MARKER}"
    }

    // æ·»åŠ æŠ¥å‘Šå‚æ•°
    command += " --json-report --json-report-file=${CONFIG.reportFile}"
    command += " --junitxml=${CONFIG.junitFile}"
    command += " --html=report.html --self-contained-html"
    command += " -v --tb=short"

    // å¹¶è¡Œæ‰§è¡Œ
    if (params.ENABLE_PARALLEL) {
        command += " -n auto"
    }

    // å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ
    command += " || true"

    return command
}

/**
 * æ”¶é›†æµ‹è¯•ç»“æœ
 */
def collectTestResults() {
    echo "ğŸ“Š æ”¶é›†æµ‹è¯•ç»“æœ..."

    def results = [
        runId: params.RUN_ID.toInteger(),
        status: 'success',
        passedCases: 0,
        failedCases: 0,
        skippedCases: 0,
        totalCases: 0,
        durationMs: 0,
        buildUrl: BUILD_URL,
        buildNumber: BUILD_NUMBER,
        results: []
    ]

    dir(CONFIG.testCaseDir) {
        // è¯»å– JSON æŠ¥å‘Š
        if (fileExists(CONFIG.reportFile)) {
            def reportContent = readFile(CONFIG.reportFile)
            def report = readJSON(text: reportContent)

            // æå–æ±‡æ€»ä¿¡æ¯
            if (report.summary) {
                results.totalCases = report.summary.total ?: 0
                results.passedCases = report.summary.passed ?: 0
                results.failedCases = report.summary.failed ?: 0
                results.skippedCases = report.summary.skipped ?: 0
                results.durationMs = (report.duration * 1000).toInteger()
            }

            // æå–è¯¦ç»†ç»“æœ
            if (report.tests) {
                results.results = report.tests.collect { test ->
                    [
                        caseName: test.nodeid,
                        status: test.outcome,
                        duration: (test.duration * 1000).toInteger(),
                        errorMessage: test.call?.longrepr ?: null
                    ]
                }
            }

            // ç¡®å®šæœ€ç»ˆçŠ¶æ€
            results.status = results.failedCases > 0 ? 'failed' : 'success'

            echo """
æµ‹è¯•ç»“æœæ±‡æ€»:
  æ€»æ•°: ${results.totalCases}
  é€šè¿‡: ${results.passedCases}
  å¤±è´¥: ${results.failedCases}
  è·³è¿‡: ${results.skippedCases}
  çŠ¶æ€: ${results.status}
  è€—æ—¶: ${results.durationMs}ms
            """
        } else {
            echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶,ç”Ÿæˆé»˜è®¤ç»“æœ"
            results.status = 'failed'
            results.failedCases = 1
        }
    }

    echo "âœ… ç»“æœæ”¶é›†å®Œæˆ"

    return results
}

/**
 * é€šçŸ¥å¹³å°
 */
def notifyPlatform(event, data = [:]) {
    def callbackUrl = params.CALLBACK_URL ?: "${CONFIG.platformUrl}/api/jenkins/callback"

    echo "ğŸ”” é€šçŸ¥å¹³å°: ${event}"
    echo "å›è°ƒåœ°å€: ${callbackUrl}"

    def payload = [
        event: event,
        timestamp: System.currentTimeMillis()
    ] + data

    def payloadJson = writeJSON(returnText: true, json: payload)

    retry(CONFIG.maxRetries) {
        sh """
            curl -X POST '${callbackUrl}' \
                -H 'Content-Type: application/json' \
                -H 'X-Api-Key: ${env.JENKINS_API_KEY}' \
                -d '${payloadJson}' \
                --max-time 30 \
                --retry 3 \
                --retry-delay ${CONFIG.retryDelay} \
                -w '\\nHTTP Status: %{http_code}\\n' \
                || (echo 'âŒ å›è°ƒå¤±è´¥' && exit 1)
        """
    }

    echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ"
}

/**
 * æœ€ç»ˆå›è°ƒ
 */
def finalCallback() {
    echo "ğŸ“ å‘é€æœ€ç»ˆå›è°ƒ..."

    if (!params.RUN_ID) {
        echo "âš ï¸ æœªæŒ‡å®šRUN_ID,è·³è¿‡æœ€ç»ˆå›è°ƒ"
        return
    }

    def finalStatus = currentBuild.result ?: 'SUCCESS'
    def status = (finalStatus == 'SUCCESS') ? 'success' : 'failed'

    try {
        def results = env.COLLECTED_RESULTS ?
            readJSON(text: env.COLLECTED_RESULTS) :
            [
                runId: params.RUN_ID.toInteger(),
                status: status,
                passedCases: 0,
                failedCases: finalStatus == 'SUCCESS' ? 0 : 1,
                skippedCases: 0,
                durationMs: currentBuild.duration ?: 0
            ]

        notifyPlatform('final', results)
    } catch (Exception e) {
        echo "âš ï¸ æœ€ç»ˆå›è°ƒå¤±è´¥: ${e.message}"
        // ä¸æŠ›å‡ºå¼‚å¸¸,é¿å…å½±å“æ„å»ºçŠ¶æ€
    }
}

/**
 * å½’æ¡£æµ‹è¯•æŠ¥å‘Š
 */
def archiveTestReports() {
    echo "ğŸ“¦ å½’æ¡£æµ‹è¯•æŠ¥å‘Š..."

    dir(CONFIG.testCaseDir) {
        // å½’æ¡£ JSON æŠ¥å‘Š
        archiveArtifacts(
            artifacts: "${CONFIG.reportFile},${CONFIG.junitFile},report.html,**/*.log",
            allowEmptyArchive: true,
            fingerprint: true
        )

        // å‘å¸ƒ JUnit æŠ¥å‘Š
        junit(
            testResults: CONFIG.junitFile,
            allowEmptyResults: true,
            skipPublishingChecks: true
        )

        // å‘å¸ƒ HTML æŠ¥å‘Š
        publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: '.',
            reportFiles: 'report.html',
            reportName: 'Test Report'
        ])
    }

    echo "âœ… æŠ¥å‘Šå½’æ¡£å®Œæˆ"
}

/**
 * æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
 */
def buildAndPushDockerImage() {
    echo "ğŸ³ æ„å»ºå¹¶æ¨é€Dockeré•œåƒ..."

    def imageTag = "${BUILD_NUMBER}"
    def fullImageName = "${CONFIG.dockerRegistry}/${CONFIG.dockerRepo}:${imageTag}"

    try {
        // ç™»å½• Docker Registry
        sh """
            echo ${DOCKER_CREDENTIALS_PSW} | docker login \
                --username ${DOCKER_CREDENTIALS_USR} \
                --password-stdin \
                ${CONFIG.dockerRegistry}
        """

        // æ„å»ºé•œåƒ
        sh "docker build -t ${fullImageName} ."

        // æ¨é€é•œåƒ
        sh "docker push ${fullImageName}"

        // æ ‡è®°ä¸º latest
        sh """
            docker tag ${fullImageName} ${CONFIG.dockerRegistry}/${CONFIG.dockerRepo}:latest
            docker push ${CONFIG.dockerRegistry}/${CONFIG.dockerRepo}:latest
        """

        echo "âœ… é•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸ: ${fullImageName}"

    } catch (Exception e) {
        echo "âŒ é•œåƒæ„å»ºæˆ–æ¨é€å¤±è´¥: ${e.message}"
        throw e
    } finally {
        // æ¸…ç†æœ¬åœ°é•œåƒ
        sh "docker rmi ${fullImageName} || true"
    }
}

/**
 * å‘é€é€šçŸ¥
 */
def sendNotification(status) {
    // TODO: å®ç°é‚®ä»¶/é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    echo "ğŸ“§ å‘é€é€šçŸ¥: ${status}"
}

/**
 * æ¸…ç†ç¯å¢ƒ
 */
def cleanup() {
    echo "ğŸ§¹ æ¸…ç†ç¯å¢ƒ..."

    try {
        // æ¸…ç† Python ç¼“å­˜
        dir(CONFIG.testCaseDir) {
            sh """
                find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
                find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
                find . -type f -name '*.pyc' -delete 2>/dev/null || true
            """
        }

        echo "âœ… æ¸…ç†å®Œæˆ"
    } catch (Exception e) {
        echo "âš ï¸ æ¸…ç†å¤±è´¥: ${e.message}"
    }
}
