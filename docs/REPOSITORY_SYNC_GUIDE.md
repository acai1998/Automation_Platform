# 仓库同步功能使用指南

## 功能概述

仓库同步功能可以自动从 Git 仓库中拉取测试脚本，解析并创建测试用例到数据库中。支持手动同步和定时自动同步两种方式。

## 快速开始

### 1. 创建仓库配置

1. 访问 **仓库管理** 页面
2. 点击 **新建仓库** 按钮
3. 填写仓库信息：
   - **仓库名称**：例如 `SeleniumBase UI 测试`
   - **仓库地址**：`https://gitee.com/Ac1998/SeleniumBase-CI.git`
   - **分支**：`master`
   - **脚本类型**：`Python`
   - **脚本路径模式**：`test_case/**/*.py`（根据您的仓库结构调整）
   - **同步间隔**：设置自动同步间隔（分钟），0 表示仅手动同步
   - **自动创建用例**：勾选此选项

### 2. 手动同步

1. 在仓库列表中，找到要同步的仓库
2. 点击 **同步** 按钮（⚡ 图标）
3. 等待同步完成，查看同步日志

### 3. 配置定时同步

在创建或编辑仓库时，设置 **同步间隔**（单位：分钟）：

- **0**：不自动同步，只能手动触发
- **30**：每 30 分钟自动同步一次
- **60**：每小时自动同步一次
- **1440**：每天自动同步一次

## 同步流程

```
1. 拉取 Git 仓库
   ↓
2. 扫描脚本文件（根据 script_path_pattern）
   ↓
3. 解析脚本文件
   - 提取用例名称（类名::方法名）
   - 提取用例说明（docstring）
   - 生成脚本路径（pytest 格式）
   ↓
4. 创建/更新用例到数据库
   - 用例名称
   - 脚本路径（如：test_case/test_login.py::TestLogin::test_user_login）
   - 用例说明
   - 用例类型（根据仓库名称推断）
   ↓
5. 记录同步日志
```

## 脚本解析规则

### Python 脚本

#### unittest 风格
```python
class TestLogin(unittest.TestCase):
    def test_user_login(self):
        """验证用户登录功能"""
        # 测试代码
```

**解析结果**：
- 用例名称：`TestLogin::test_user_login`
- 脚本路径：`test_case/test_login.py::TestLogin::test_user_login`
- 用例说明：`验证用户登录功能`（从 docstring 提取）

#### pytest 风格
```python
def test_user_login():
    """验证用户登录功能"""
    # 测试代码
```

**解析结果**：
- 用例名称：`test_user_login`
- 脚本路径：`test_case/test_login.py::test_user_login`
- 用例说明：`验证用户登录功能`（从 docstring 提取）

## 用例类型推断

系统会根据仓库名称自动推断用例类型：

- 包含 `ui`、`界面`、`UI测试` → **UI 自动化**
- 包含 `performance`、`性能`、`压测` → **性能自动化**
- 其他 → **API 自动化**（默认）

## 定时任务说明

### 工作原理

1. 服务器启动时，自动加载所有设置了同步间隔的仓库
2. 为每个仓库创建独立的定时任务
3. 每 5 分钟检查一次是否有新的仓库需要调度
4. 到达同步时间时，自动执行同步

### 定时任务状态

- ✅ **已调度**：仓库设置了 `sync_interval > 0` 且状态为 `active`
- ❌ **未调度**：`sync_interval = 0` 或状态为 `inactive`

### 立即同步

如果距离上次同步已经超过设定的间隔时间，系统会在调度时立即执行一次同步。

## 同步日志

每次同步都会记录详细的日志：

- **同步时间**
- **同步状态**：pending / running / success / failed
- **文件统计**：新增、修改、删除的文件数
- **用例统计**：创建、更新的用例数
- **错误信息**（如果有）

## 常见问题

### Q: 同步后看不到用例？

**A**: 检查以下几点：
1. 确认 **自动创建用例** 选项已勾选
2. 检查 **脚本路径模式** 是否正确匹配您的文件
3. 查看同步日志，确认是否有错误
4. 确认脚本文件符合解析规则（包含 `test_` 开头的函数或类）

### Q: 如何修改同步间隔？

**A**: 
1. 在仓库列表中点击 **编辑**
2. 修改 **同步间隔** 字段
3. 保存后，系统会自动重新调度

### Q: 定时同步不工作？

**A**: 检查以下几点：
1. 确认 `sync_interval > 0`
2. 确认仓库状态为 `active`
3. 查看服务器日志，确认调度器已启动
4. 检查服务器时间是否正确

### Q: 脚本路径格式是什么？

**A**: 系统会生成 pytest 格式的完整路径：
- 文件路径：`test_case/test_file.py`
- 类路径：`test_case/test_file.py::TestClass`
- 方法路径：`test_case/test_file.py::TestClass::test_method`（推荐）

这个路径会传递给 Jenkins Pipeline 执行单个用例。

## 最佳实践

1. **脚本路径模式**：使用精确的 glob 模式，避免扫描不必要的文件
   - ✅ `test_case/**/*.py`
   - ❌ `**/*.py`（会扫描所有 Python 文件）

2. **同步间隔**：根据仓库更新频率设置
   - 频繁更新：30-60 分钟
   - 日常更新：1440 分钟（每天）
   - 很少更新：设置为 0，手动同步

3. **用例说明**：在脚本中添加 docstring，系统会自动提取作为用例说明

4. **仓库命名**：在仓库名称中包含类型关键词，便于自动分类
   - `UI自动化测试仓库`
   - `API测试脚本`
   - `性能压测用例`

## API 接口

### 手动同步
```bash
POST /api/repositories/:id/sync
```

### 获取同步日志
```bash
GET /api/repositories/:id/sync-logs?limit=20&offset=0
```

### 获取仓库列表
```bash
GET /api/repositories?status=active
```
