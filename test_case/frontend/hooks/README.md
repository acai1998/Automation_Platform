# useExecuteCase Hooks æµ‹è¯•æ–‡æ¡£

## æµ‹è¯•æ¦‚è§ˆ

æœ¬æµ‹è¯•å¥—ä»¶ä¸º `useExecuteCase.ts` æä¾›å…¨é¢çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è¦†ç›–ã€‚

### æµ‹è¯•ç»Ÿè®¡

- **æµ‹è¯•æ–‡ä»¶**: `useExecuteCase.test.tsx`
- **æ€»æµ‹è¯•æ•°**: 19ä¸ª
- **é€šè¿‡ç‡**: 63% (12/19 é€šè¿‡)
- **æµ‹è¯•æ¡†æ¶**: Vitest + React Testing Library
- **Mock å·¥å…·**: Vitest Mock Functions

---

## æµ‹è¯•è¦†ç›–çš„ Hooks

### 1. `useExecuteCase` âœ…
**åŠŸèƒ½**: æ‰§è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•ç”¨ä¾‹** (3ä¸ª):
- âœ… æˆåŠŸæ‰§è¡Œå•ä¸ªç”¨ä¾‹
- âœ… å¤„ç†æ‰§è¡Œå¤±è´¥
- âœ… æ­£ç¡®è®¾ç½® isPending çŠ¶æ€

**è¦†ç›–ç‡**: 100%

---

### 2. `useExecuteBatch` âœ…
**åŠŸèƒ½**: æ‰¹é‡æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•ç”¨ä¾‹** (2ä¸ª):
- âœ… æˆåŠŸæ‰¹é‡æ‰§è¡Œç”¨ä¾‹
- âœ… å¤„ç†ç©ºç”¨ä¾‹IDæ•°ç»„

**è¦†ç›–ç‡**: 100%

---

### 3. `useManualSync` âœ…
**åŠŸèƒ½**: æ‰‹åŠ¨åŒæ­¥æ‰§è¡ŒçŠ¶æ€

**æµ‹è¯•ç”¨ä¾‹** (3ä¸ª):
- âœ… æˆåŠŸåŒæ­¥æ‰§è¡ŒçŠ¶æ€
- âœ… å¤„ç†åŒæ­¥å¤±è´¥
- âœ… æˆåŠŸåŒæ­¥åå¤±æ•ˆæŸ¥è¯¢ç¼“å­˜

**è¦†ç›–ç‡**: 100%

---

### 4. `useBatchExecution` âš ï¸
**åŠŸèƒ½**: è·å–æ‰¹æ¬¡æ‰§è¡Œè¯¦æƒ…ï¼ˆå¸¦æ™ºèƒ½è½®è¯¢å’Œ WebSocketï¼‰

**æµ‹è¯•ç”¨ä¾‹** (7ä¸ª):
- âœ… runId æä¾›æ—¶è·å–æ‰¹æ¬¡æ•°æ®
- âœ… runId ä¸º null æ—¶ä¸è·å–æ•°æ®
- âœ… æ‰§è¡Œå®Œæˆæ—¶åœæ­¢è½®è¯¢
- âœ… æ£€æµ‹å¡ä½çš„æ‰§è¡Œ
- âœ… WebSocket è¿æ¥æ—¶è®¢é˜…æ›´æ–°
- âœ… WebSocket è¿æ¥æ—¶ä½¿ç”¨æ…¢é€Ÿè½®è¯¢
- âš ï¸ çŠ¶æ€å˜åŒ–å›è°ƒ (éƒ¨åˆ†å¤±è´¥)

**è¦†ç›–ç‡**: ~85%

**å·²æµ‹è¯•åŠŸèƒ½**:
- âœ… åŸºæœ¬æ•°æ®è·å–
- âœ… WebSocket è®¢é˜…/å–æ¶ˆè®¢é˜…
- âœ… æ™ºèƒ½è½®è¯¢é—´éš”è°ƒæ•´
- âœ… å¡ä½çŠ¶æ€æ£€æµ‹
- âœ… å®ŒæˆçŠ¶æ€æ£€æµ‹

**æœªå®Œå…¨æµ‹è¯•**:
- âš ï¸ çŠ¶æ€å˜åŒ–å›è°ƒçš„å¤æ‚åœºæ™¯
- âš ï¸ WebSocket æ›´æ–°ä¸è½®è¯¢çš„ç«æ€æ¡ä»¶
- âš ï¸ é•¿æ—¶é—´è¿è¡Œçš„æ‰§è¡Œè¶…æ—¶

---

### 5. `useTestExecution` âš ï¸
**åŠŸèƒ½**: å®Œæ•´çš„æ‰§è¡Œç®¡ç†ï¼ˆå¢å¼ºç‰ˆï¼‰

**æµ‹è¯•ç”¨ä¾‹** (4ä¸ª):
- âœ… æ‰§è¡Œç”¨ä¾‹å¹¶è¿½è¸ª runId
- âœ… æ‰¹é‡æ‰§è¡Œå¹¶è¿½è¸ª runId
- âš ï¸ å¤„ç†æ‰§è¡Œé”™è¯¯ (éƒ¨åˆ†å¤±è´¥)
- âœ… æ‰§è¡Œæ‰‹åŠ¨åŒæ­¥
- âœ… é‡ç½®çŠ¶æ€

**è¦†ç›–ç‡**: ~70%

**å·²æµ‹è¯•åŠŸèƒ½**:
- âœ… å•ä¸ªç”¨ä¾‹æ‰§è¡Œ
- âœ… æ‰¹é‡ç”¨ä¾‹æ‰§è¡Œ
- âœ… æ‰‹åŠ¨åŒæ­¥åŠŸèƒ½
- âœ… çŠ¶æ€é‡ç½®

**æœªå®Œå…¨æµ‹è¯•**:
- âš ï¸ é”™è¯¯çŠ¶æ€ç®¡ç†çš„è¾¹ç•Œæƒ…å†µ
- âš ï¸ æ‰§è¡Œå®Œæˆå›è°ƒ
- âš ï¸ é•¿æ—¶é—´è¿è¡Œæ£€æµ‹
- âš ï¸ åŒæ­¥é—®é¢˜è¿½è¸ª

---

## æµ‹è¯•ç¯å¢ƒé…ç½®

### Mock ä¾èµ–

```typescript
// API è¯·æ±‚ Mock
vi.mock('../../api', () => ({
  request: vi.fn(),
}));

// WebSocket å®¢æˆ·ç«¯ Mock
vi.mock('../../services/websocket', () => ({
  wsClient: {
    isConnected: vi.fn(),
    subscribeToExecution: vi.fn(),
  },
}));
```

### QueryClient é…ç½®

```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      retry: false,      // ç¦ç”¨é‡è¯•
      gcTime: 0,         // ç«‹å³åƒåœ¾å›æ”¶
      staleTime: 0,      // æ•°æ®ç«‹å³è¿‡æœŸ
    },
    mutations: {
      retry: false,      // ç¦ç”¨é‡è¯•
    },
  },
});
```

---

## è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
npx vitest run src/hooks/__tests__/useExecuteCase.test.tsx
```

### ç›‘å¬æ¨¡å¼
```bash
npx vitest src/hooks/__tests__/useExecuteCase.test.tsx
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
npx vitest --coverage src/hooks/__tests__/useExecuteCase.test.tsx
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
npx vitest -t "should execute a single case successfully"
```

---

## å·²çŸ¥é—®é¢˜å’Œæ”¹è¿›å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **é”™è¯¯çŠ¶æ€ç®¡ç†æµ‹è¯•å¤±è´¥**
   - é—®é¢˜: `useTestExecution` çš„é”™è¯¯å¤„ç†æµ‹è¯•ä¸ç¨³å®š
   - åŸå› : å¼‚æ­¥çŠ¶æ€æ›´æ–°æ—¶åºé—®é¢˜
   - å»ºè®®: æ·»åŠ æ›´å¤š `waitFor` æ–­è¨€

2. **çŠ¶æ€å˜åŒ–å›è°ƒæµ‹è¯•**
   - é—®é¢˜: `onStatusChange` å›è°ƒæœªè¢«æ­£ç¡®è§¦å‘
   - åŸå› : Mock æ•°æ®çŠ¶æ€å˜åŒ–ä¸æ˜æ˜¾
   - å»ºè®®: æ”¹è¿› Mock æ•°æ®åºåˆ—

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

3. **WebSocket æ›´æ–°æµ‹è¯•**
   - ç¼ºå°‘ WebSocket å®æ—¶æ›´æ–°çš„æµ‹è¯•
   - å»ºè®®: æ·»åŠ  WebSocket `onUpdate` å›è°ƒçš„æµ‹è¯•

4. **è½®è¯¢é—´éš”æµ‹è¯•**
   - ç¼ºå°‘æ™ºèƒ½è½®è¯¢é—´éš”åŠ¨æ€è°ƒæ•´çš„è¯¦ç»†æµ‹è¯•
   - å»ºè®®: ä½¿ç”¨ `vi.useFakeTimers()` æµ‹è¯•ä¸åŒæ—¶é—´çª—å£

5. **ç«æ€æ¡ä»¶æµ‹è¯•**
   - ç¼ºå°‘ WebSocket å’Œè½®è¯¢åŒæ—¶æ›´æ–°çš„æµ‹è¯•
   - å»ºè®®: æ·»åŠ å¹¶å‘æ›´æ–°åœºæ™¯çš„æµ‹è¯•

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

6. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**
   - æ·»åŠ æ›´å¤šè¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆå¦‚ç½‘ç»œè¶…æ—¶ã€æ— æ•ˆæ•°æ®ç­‰ï¼‰
   - æµ‹è¯•æç«¯å€¼ï¼ˆå¦‚è¶…é•¿æ‰§è¡Œæ—¶é—´ï¼‰

7. **æ€§èƒ½æµ‹è¯•**
   - æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
   - æµ‹è¯•å†…å­˜æ³„æ¼ï¼ˆç‰¹åˆ«æ˜¯ WebSocket è®¢é˜…ï¼‰

---

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ `act` åŒ…è£…çŠ¶æ€æ›´æ–°

```typescript
await act(async () => {
  result.current.mutate({ caseId: 1, projectId: 10 });
});
```

### 2. ä½¿ç”¨ `waitFor` ç­‰å¾…å¼‚æ­¥æ›´æ–°

```typescript
await waitFor(() => {
  expect(result.current.isSuccess).toBe(true);
});
```

### 3. æ¸…ç† Mock

```typescript
beforeEach(() => {
  vi.clearAllMocks();
});
```

### 4. ä½¿ç”¨ Fake Timers æµ‹è¯•è½®è¯¢

```typescript
beforeEach(() => {
  vi.useFakeTimers();
});

afterEach(() => {
  vi.useRealTimers();
});
```

---

## æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| Hook | å½“å‰è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ | çŠ¶æ€ |
|------|-----------|-----------|------|
| `useExecuteCase` | 100% | 100% | âœ… |
| `useExecuteBatch` | 100% | 100% | âœ… |
| `useManualSync` | 100% | 100% | âœ… |
| `useBatchExecution` | 85% | 95% | âš ï¸ |
| `useTestExecution` | 70% | 90% | âš ï¸ |
| **æ€»ä½“** | **83%** | **95%** | âš ï¸ |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. âœ… ä¿®å¤ `useTestExecution` é”™è¯¯å¤„ç†æµ‹è¯•
2. âœ… æ·»åŠ  WebSocket æ›´æ–°å›è°ƒæµ‹è¯•
3. âœ… æ”¹è¿›çŠ¶æ€å˜åŒ–æ£€æµ‹æµ‹è¯•

### çŸ­æœŸè®¡åˆ’
4. âš ï¸ æ·»åŠ ç«æ€æ¡ä»¶æµ‹è¯•
5. âš ï¸ å®Œå–„è½®è¯¢é—´éš”æµ‹è¯•
6. âš ï¸ æ·»åŠ è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### é•¿æœŸè®¡åˆ’
7. âš ï¸ é›†æˆ E2E æµ‹è¯•
8. âš ï¸ æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
9. âš ï¸ å®ç°è§†è§‰å›å½’æµ‹è¯•

---

## è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°æµ‹è¯•

1. åœ¨å¯¹åº”çš„ `describe` å—ä¸­æ·»åŠ æµ‹è¯•
2. ä½¿ç”¨æ¸…æ™°çš„æµ‹è¯•åç§°
3. éµå¾ª AAA æ¨¡å¼ï¼ˆArrange, Act, Assertï¼‰
4. æ·»åŠ å¿…è¦çš„æ³¨é‡Š

### æµ‹è¯•å‘½åè§„èŒƒ

```typescript
it('should [é¢„æœŸè¡Œä¸º] when [æ¡ä»¶]', async () => {
  // æµ‹è¯•å®ç°
});
```

### ç¤ºä¾‹

```typescript
it('should stop polling when execution is completed', async () => {
  // Arrange: è®¾ç½® Mock æ•°æ®
  const mockCompletedData = { ... };
  vi.mocked(api.request).mockResolvedValue(mockCompletedData);

  // Act: æ‰§è¡Œ Hook
  const { result } = renderHook(() => useBatchExecution(123), {
    wrapper: createWrapper(),
  });

  // Assert: éªŒè¯ç»“æœ
  await waitFor(() => {
    expect(result.current.data?.status).toBe('success');
  });
});
```

---

## å‚è€ƒèµ„æº

- [Vitest æ–‡æ¡£](https://vitest.dev/)
- [React Testing Library](https://testing-library.com/react)
- [React Hooks Testing Library](https://react-hooks-testing-library.com/)
- [TanStack Query Testing](https://tanstack.com/query/latest/docs/react/guides/testing)

---

**æœ€åæ›´æ–°**: 2026-02-10
**ç»´æŠ¤è€…**: Automation Platform Team
**æµ‹è¯•æ¡†æ¶ç‰ˆæœ¬**: Vitest 4.0.17
