pipeline {
    agent any

    parameters {
        string(name: 'RUN_ID', description: 'æ‰§è¡Œæ‰¹æ¬¡ID', defaultValue: '')
        string(name: 'SCRIPT_PATHS', description: 'è„šæœ¬è·¯å¾„(é€—å·åˆ†éš”)', defaultValue: '')
        string(name: 'CALLBACK_URL', description: 'å›è°ƒURL', defaultValue: '')
        string(name: 'MARKER', description: 'Pytest markeræ ‡è®°', defaultValue: '')
        string(name: 'REPO_URL', description: 'æµ‹è¯•ç”¨ä¾‹ä»“åº“URL', defaultValue: '')
        string(name: 'JENKINS_API_KEY', description: 'Jenkins APIå¯†é’¥ç”¨äºå›è°ƒè®¤è¯', defaultValue: '')
    }

    environment {
        PLATFORM_API_URL = 'http://localhost:3000'
        PYTHON_ENV = "${WORKSPACE}/venv"
    }

    stages {
        stage('å‡†å¤‡') {
            steps {
                script {
                    echo "========== æ‰§è¡Œä¿¡æ¯ =========="
                    echo "è¿è¡ŒID: ${params.RUN_ID}"
                    echo "è„šæœ¬è·¯å¾„: ${params.SCRIPT_PATHS}"
                    echo "å›è°ƒåœ°å€: ${params.CALLBACK_URL}"
                    echo "==============================="

                    // æ ‡è®°æ‰§è¡Œå¼€å§‹ï¼ˆå¯é€‰ï¼‰
                    if (params.RUN_ID) {
                        sh '''
                            curl -X POST "${PLATFORM_API_URL}/api/executions/${RUN_ID}/start" \
                                -H "Content-Type: application/json"
                        '''
                    }
                }
            }
        }

        stage('æ£€å‡ºä»£ç ') {
            steps {
                script {
                    echo "æ­£åœ¨å…‹éš†/æ›´æ–°æµ‹è¯•ç”¨ä¾‹ä»“åº“..."

                    if (params.REPO_URL) {
                        if (fileExists('test-cases')) {
                            dir('test-cases') {
                                sh 'git pull origin main'
                            }
                        } else {
                            sh 'git clone ${params.REPO_URL} test-cases'
                        }
                    } else {
                        echo "âš ï¸ è­¦å‘Šï¼šREPO_URL æœªè®¾ç½®ï¼Œè·³è¿‡ä»£ç æ£€å‡º"
                        echo "ä½¿ç”¨é»˜è®¤çš„æµ‹è¯•ç”¨ä¾‹ç›®å½•"
                    }
                }
            }
        }

        stage('å‡†å¤‡ç¯å¢ƒ') {
            steps {
                script {
                    echo "å‡†å¤‡Pythonç¯å¢ƒ..."

                    sh '''
                        cd test-cases

                        # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                        if [ ! -d "${PYTHON_ENV}" ]; then
                            python3 -m venv ${PYTHON_ENV}
                        fi

                        # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
                        source ${PYTHON_ENV}/bin/activate
                        pip install -q pytest pytest-json-report

                        # åˆ—å‡ºå¯ç”¨çš„ç”¨ä¾‹
                        echo "å¯ç”¨çš„æµ‹è¯•æ–‡ä»¶:"
                        find . -name "test_*.py" -o -name "*_test.py" | head -20
                    '''
                }
            }
        }

        stage('æ‰§è¡Œæµ‹è¯•') {
            steps {
                script {
                    def scriptPaths = params.SCRIPT_PATHS
                    def marker = params.MARKER
                    def testCommand = "source ${PYTHON_ENV}/bin/activate && "

                    if (scriptPaths) {
                        // æ‰§è¡ŒæŒ‡å®šçš„è„šæœ¬è·¯å¾„
                        def paths = scriptPaths.split(',')
                        testCommand += "pytest ${paths.join(' ')}"
                    } else if (marker) {
                        // ä½¿ç”¨markeræ ‡è®°æ‰§è¡Œ
                        testCommand += "pytest -m ${marker}"
                    } else {
                        // æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
                        testCommand += "pytest"
                    }

                    // æ·»åŠ æŠ¥å‘Šè¾“å‡ºå‚æ•°
                    testCommand += " --json-report --json-report-file=test-report.json -v"

                    sh '''
                        cd test-cases
                        ''' + testCommand + ''' || true
                    '''
                }
            }
        }

        stage('å›è°ƒå¹³å°') {
            steps {
                script {
                    echo "å›è°ƒæµ‹è¯•ç»“æœåˆ°å¹³å°..."

                    // ä½¿ç”¨Jenkins native APIè·å–æ‰§è¡Œæ—¶é•¿
                    def durationMs = currentBuild.duration ?: 0
                    def callbackUrl = params.CALLBACK_URL ?: "${env.PLATFORM_API_URL}/api/jenkins/callback"

                    try {
                        // è§£ææµ‹è¯•ç»“æœ
                        def testReport = null
                        def total = 0
                        def passed = 0
                        def failed = 0
                        def skipped = 0
                        def status = "success"

                        // æ£€æŸ¥æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                        if (fileExists('test-cases/test-report.json')) {
                            echo "âœ… æ‰¾åˆ°æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ï¼Œè§£æç»“æœ..."
                            def reportContent = sh(
                                script: '''
                                    cd test-cases
                                    if command -v jq >/dev/null 2>&1; then
                                        jq -c '.summary' test-report.json 2>/dev/null || echo '{"total":0,"passed":0,"failed":0,"skipped":0}'
                                    else
                                        echo '{"total":0,"passed":0,"failed":0,"skipped":0}'
                                    fi
                                ''',
                                returnStdout: true
                            ).trim()

                            testReport = readJSON text: reportContent
                            total = testReport.total ?: 0
                            passed = testReport.passed ?: 0
                            failed = testReport.failed ?: 0
                            skipped = testReport.skipped ?: 0
                            status = (failed == 0) ? "success" : "failed"
                        } else {
                            echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                            // å¦‚æœæ²¡æœ‰æŠ¥å‘Šæ–‡ä»¶ï¼Œæ ¹æ®æ„å»ºçŠ¶æ€æ¨æ–­
                            def buildResult = currentBuild.result ?: 'SUCCESS'
                            status = (buildResult == 'SUCCESS') ? 'success' : 'failed'
                            failed = (status == 'failed') ? 1 : 0
                        }

                        echo "æµ‹è¯•ç»“æœæ±‡æ€»:"
                        echo "  æ€»æ•°: ${total}"
                        echo "  é€šè¿‡: ${passed}"
                        echo "  å¤±è´¥: ${failed}"
                        echo "  è·³è¿‡: ${skipped}"
                        echo "  çŠ¶æ€: ${status}"
                        echo "  è€—æ—¶: ${durationMs}ms"

                        // å›è°ƒåˆ°å¹³å°
                        if (params.RUN_ID && callbackUrl) {
                            echo "å‘é€å›è°ƒåˆ°: ${callbackUrl}"
                            def response = sh(
                                script: """
                                    curl -X POST '${callbackUrl}' \
                                        -H 'Content-Type: application/json' \
                                        -H 'X-Api-Key: ${params.JENKINS_API_KEY}' \
                                        -w '\\n%{http_code}' \
                                        -d '{
                                            "runId": ${params.RUN_ID},
                                            "status": "${status}",
                                            "passedCases": ${passed},
                                            "failedCases": ${failed},
                                            "skippedCases": ${skipped},
                                            "durationMs": ${durationMs},
                                            "buildUrl": "${BUILD_URL}"
                                        }'
                                """,
                                returnStdout: true
                            ).trim()

                            def lines = response.split('\n')
                            def httpCode = lines[-1]
                            if (httpCode == '200' || httpCode == '201') {
                                echo "âœ… å›è°ƒæˆåŠŸ (HTTP ${httpCode})"
                            } else {
                                echo "âš ï¸ å›è°ƒè¿”å›éæˆåŠŸçŠ¶æ€ç : HTTP ${httpCode}"
                                echo "å“åº”å†…å®¹: ${lines[0..-2].join('\n')}"
                            }
                        } else {
                            echo "âš ï¸ è·³è¿‡å›è°ƒ: RUN_ID=${params.RUN_ID}, CALLBACK_URL=${callbackUrl}"
                        }
                    } catch (Exception e) {
                        echo "âŒ å›è°ƒå¤„ç†å¤±è´¥: ${e.message}"
                        echo "å †æ ˆè·Ÿè¸ª: ${e.toString()}"
                        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸pipelineç»§ç»­æ‰§è¡Œ
                    }
                }
            }
        }

        // âœ… æ–°å¢: å½’æ¡£æŠ¥å‘Šé˜¶æ®µ - åœ¨ stages ä¸­æ‰§è¡Œ,æœ‰å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
        stage('å½’æ¡£æŠ¥å‘Š') {
            steps {
                script {
                    echo "å½’æ¡£æµ‹è¯•æŠ¥å‘Š..."

                    try {
                        archiveArtifacts artifacts: 'test-cases/test-report.json',
                                       allowEmptyArchive: true,
                                       fingerprint: true
                        echo "âœ… æµ‹è¯•æŠ¥å‘Šå·²å½’æ¡£"
                    } catch (Exception e) {
                        echo "âš ï¸ å½’æ¡£æµ‹è¯•æŠ¥å‘Šå¤±è´¥: ${e.message}"
                    }

                    try {
                        junit allowEmptyResults: true,
                              testResults: '**/test-cases/junit.xml,**/test-cases/.pytest_cache/**/junit.xml'
                        echo "âœ… JUnitæŠ¥å‘Šå·²å‘å¸ƒ"
                    } catch (Exception e) {
                        echo "âš ï¸ JUnitæŠ¥å‘Šå¤„ç†å¤±è´¥: ${e.message}"
                    }
                }
            }
        }

        stage('æ„å»ºé•œåƒ') {
            when {
                expression { return currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    echo "æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."

                    def dockerRegistry = "crpi-dytkl1o45qyeksph.cn-hangzhou.personal.cr.aliyuncs.com"
                    def imageRepo = "caijinwei/auto_test"
                    def imageTag = "${BUILD_NUMBER}"
                    def fullImageName = "${dockerRegistry}/${imageRepo}:${imageTag}"

                    try {
                        // 1. ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
                        withCredentials([usernamePassword(credentialsId: 'aliyun-docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                            sh """
                                echo "ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
                                docker login --username=${DOCKER_USERNAME} --password=${DOCKER_PASSWORD} ${dockerRegistry}
                            """
                        }

                        // 2. æ„å»ºDockeré•œåƒ
                        echo "æ„å»ºDockeré•œåƒ..."
                        sh """
                            docker build -t ${imageRepo}:${imageTag} .
                        """

                        // 3. æ ‡ç­¾é•œåƒ
                        echo "ä¸ºé˜¿é‡Œäº‘ä»“åº“æ ‡ç­¾é•œåƒ..."
                        sh """
                            docker tag ${imageRepo}:${imageTag} ${fullImageName}
                        """

                        // 4. æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘
                        echo "æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
                        sh """
                            docker push ${fullImageName}
                        """

                        echo "âœ… é•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸ: ${fullImageName}"

                        // 5. æ¨é€åˆ°GitHubï¼ˆå¼ºåˆ¶æ¨é€ï¼‰
                        echo "æ¨é€ä»£ç åˆ°GitHub..."
                        withCredentials([usernamePassword(credentialsId: 'git-credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                            sh """
                                git push https://${GIT_USER}:${GIT_PASS}@github.com/ImAcaiy/Automation_Platform.git HEAD:master --force
                                echo "âœ… GitHubæ¨é€æˆåŠŸ"
                            """
                        }
                    } catch (Exception e) {
                        echo "âŒ é•œåƒæ„å»ºæˆ–æ¨é€å¤±è´¥: ${e.message}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }
    }

    // âœ… post å—åªåšç®€å•çš„æ—¥å¿—è¾“å‡º,ä¸åšæ–‡ä»¶æ“ä½œ
    post {
        always {
            script {
                echo "========== Pipeline æ‰§è¡Œå®Œæˆ =========="
                echo "æ„å»ºç¼–å·: ${BUILD_NUMBER}"
                echo "æ„å»ºç»“æœ: ${currentBuild.result ?: 'SUCCESS'}"
                echo "æ„å»ºæ—¶é•¿: ${currentBuild.duration ?: 0}ms"
                echo "======================================"
            }
        }

        success {
            script {
                echo "âœ… Pipelineæ‰§è¡ŒæˆåŠŸ"
            }
        }

        failure {
            script {
                echo "âŒ Pipelineæ‰§è¡Œå¤±è´¥"
                echo "è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦æƒ…"
            }
        }

        unstable {
            script {
                echo "âš ï¸ Pipelineæ‰§è¡Œä¸ç¨³å®š"
            }
        }

        aborted {
            script {
                echo "ğŸ›‘ Pipelineè¢«ä¸­æ­¢"
            }
        }
    }
}
