pipeline {
    agent any

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'staging', 'production'],
            description: 'éƒ¨ç½²ç¯å¢ƒ'
        )
        choice(
            name: 'DEPLOY_STRATEGY',
            choices: ['rolling', 'blue-green', 'recreate'],
            description: 'éƒ¨ç½²ç­–ç•¥'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'è·³è¿‡æµ‹è¯•é˜¶æ®µ'
        )
        booleanParam(
            name: 'FORCE_REBUILD',
            defaultValue: false,
            description: 'å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒ'
        )
        string(
            name: 'DOCKER_TAG',
            defaultValue: '',
            description: 'è‡ªå®šä¹‰Dockeré•œåƒæ ‡ç­¾ (ç•™ç©ºåˆ™ä½¿ç”¨BUILD_NUMBER)'
        )
    }

    environment {
        // åº”ç”¨é…ç½®
        APP_NAME = 'automation-platform'
        DOCKER_REGISTRY = credentials('docker-registry-url')
        DOCKER_CREDENTIALS = credentials('docker-registry-credentials')

        // è¿œç¨‹æœåŠ¡å™¨é…ç½®
        DEPLOY_HOST = credentials('deploy-host')
        DEPLOY_USER = credentials('deploy-user')
        DEPLOY_SSH_KEY = credentials('deploy-ssh-key')

        // æ•°æ®åº“é…ç½®
        DB_HOST = credentials('db-host')
        DB_CREDENTIALS = credentials('db-credentials')

        // åº”ç”¨å¯†é’¥
        JWT_SECRET = credentials('jwt-secret')
        JENKINS_API_KEY = credentials('jenkins-api-key')

        // åŠ¨æ€å˜é‡
        BUILD_VERSION = "${params.DOCKER_TAG ?: env.BUILD_NUMBER}"
        IMAGE_NAME = "${DOCKER_REGISTRY}/${APP_NAME}"
        IMAGE_TAG = "${IMAGE_NAME}:${BUILD_VERSION}"
        COMPOSE_PROJECT_NAME = "${APP_NAME}-${params.ENVIRONMENT}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
        ansiColor('xterm')
    }

    stages {
        stage('å‡†å¤‡') {
            steps {
                script {
                    echo """
                    ========================================
                    ğŸš€ å¼€å§‹ CI/CD éƒ¨ç½²æµæ°´çº¿
                    ========================================
                    åº”ç”¨åç§°: ${APP_NAME}
                    éƒ¨ç½²ç¯å¢ƒ: ${params.ENVIRONMENT}
                    éƒ¨ç½²ç­–ç•¥: ${params.DEPLOY_STRATEGY}
                    æ„å»ºç‰ˆæœ¬: ${BUILD_VERSION}
                    é•œåƒæ ‡ç­¾: ${IMAGE_TAG}
                    è·³è¿‡æµ‹è¯•: ${params.SKIP_TESTS}
                    å¼ºåˆ¶é‡å»º: ${params.FORCE_REBUILD}
                    ========================================
                    """

                    // æ£€æŸ¥å¿…è¦çš„å‡­æ®
                    if (!env.DOCKER_REGISTRY || !env.DEPLOY_HOST) {
                        error('âŒ ç¼ºå°‘å¿…è¦çš„éƒ¨ç½²å‡­æ®é…ç½®')
                    }
                }
            }
        }

        stage('ä»£ç æ£€å‡º') {
            steps {
                script {
                    echo 'ğŸ“¥ æ£€å‡ºæºä»£ç ...'

                    // æ¸…ç†å·¥ä½œç›®å½•
                    deleteDir()

                    // æ£€å‡ºä»£ç 
                    checkout scm

                    // æ˜¾ç¤ºæäº¤ä¿¡æ¯
                    sh '''
                        echo "å½“å‰æäº¤ä¿¡æ¯:"
                        git log --oneline -n 5
                        echo "åˆ†æ”¯ä¿¡æ¯:"
                        git branch -a
                    '''
                }
            }
        }

        stage('ç¯å¢ƒå‡†å¤‡') {
            steps {
                script {
                    echo 'ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ...'

                    sh '''
                        # æ£€æŸ¥å¿…è¦çš„å·¥å…·
                        echo "æ£€æŸ¥ç³»ç»Ÿå·¥å…·..."
                        node --version
                        npm --version
                        docker --version
                        docker-compose --version

                        # æ£€æŸ¥ç£ç›˜ç©ºé—´
                        echo "ç£ç›˜ç©ºé—´æ£€æŸ¥:"
                        df -h

                        # æ¸…ç†æ—§çš„Dockerèµ„æºï¼ˆå¦‚æœéœ€è¦ï¼‰
                        if [ "${FORCE_REBUILD}" = "true" ]; then
                            echo "å¼ºåˆ¶é‡å»ºæ¨¡å¼ï¼Œæ¸…ç†æ—§é•œåƒ..."
                            docker image prune -f || true
                            docker builder prune -f || true
                        fi
                    '''
                }
            }
        }

        stage('ä¾èµ–å®‰è£…') {
            steps {
                script {
                    echo 'ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–...'

                    sh '''
                        # æ£€æŸ¥ package.json æ˜¯å¦å­˜åœ¨
                        if [ ! -f package.json ]; then
                            echo "âŒ package.json ä¸å­˜åœ¨"
                            exit 1
                        fi

                        # å®‰è£…ä¾èµ–
                        echo "å®‰è£… npm ä¾èµ–..."
                        npm ci --only=production

                        # æ˜¾ç¤ºå·²å®‰è£…çš„å…³é”®åŒ…
                        echo "å…³é”®ä¾èµ–ç‰ˆæœ¬:"
                        npm list --depth=0 | grep -E "(react|express|typescript|vite)" || true
                    '''
                }
            }
        }

        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            when {
                not { params.SKIP_TESTS }
            }
            parallel {
                stage('TypeScript ç±»å‹æ£€æŸ¥') {
                    steps {
                        script {
                            echo 'ğŸ” TypeScript ç±»å‹æ£€æŸ¥...'

                            sh '''
                                echo "å‰ç«¯ç±»å‹æ£€æŸ¥:"
                                npx tsc --noEmit -p tsconfig.json

                                echo "åç«¯ç±»å‹æ£€æŸ¥:"
                                npx tsc --noEmit -p tsconfig.server.json

                                echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡"
                            '''
                        }
                    }
                }

                stage('ä»£ç é£æ ¼æ£€æŸ¥') {
                    steps {
                        script {
                            echo 'ğŸ“ ä»£ç é£æ ¼æ£€æŸ¥...'

                            sh '''
                                # æ£€æŸ¥æ˜¯å¦æœ‰ ESLint é…ç½®
                                if [ -f .eslintrc.js ] || [ -f .eslintrc.json ] || [ -f eslint.config.js ]; then
                                    echo "è¿è¡Œ ESLint..."
                                    npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0 || true
                                else
                                    echo "âš ï¸ æœªæ‰¾åˆ° ESLint é…ç½®ï¼Œè·³è¿‡ä»£ç é£æ ¼æ£€æŸ¥"
                                fi

                                # æ£€æŸ¥æ˜¯å¦æœ‰ Prettier é…ç½®
                                if [ -f .prettierrc ] || [ -f .prettierrc.json ] || [ -f prettier.config.js ]; then
                                    echo "æ£€æŸ¥ Prettier æ ¼å¼..."
                                    npx prettier --check . || true
                                else
                                    echo "âš ï¸ æœªæ‰¾åˆ° Prettier é…ç½®ï¼Œè·³è¿‡æ ¼å¼æ£€æŸ¥"
                                fi
                            '''
                        }
                    }
                }
            }
        }

        stage('è¿è¡Œæµ‹è¯•') {
            when {
                not { params.SKIP_TESTS }
            }
            steps {
                script {
                    echo 'ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...'

                    sh '''
                        # å®‰è£…å¼€å‘ä¾èµ–ï¼ˆæµ‹è¯•éœ€è¦ï¼‰
                        npm install --only=dev

                        # è¿è¡Œå‰ç«¯æµ‹è¯•
                        echo "è¿è¡Œå‰ç«¯æµ‹è¯•..."
                        npm run test -- --run --reporter=verbose

                        echo "âœ… æµ‹è¯•é€šè¿‡"
                    '''
                }
            }
            post {
                always {
                    // æ”¶é›†æµ‹è¯•æŠ¥å‘Šï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    publishTestResults testResultsPattern: 'test-results.xml'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report'
                    ])
                }
            }
        }

        stage('æ„å»ºåº”ç”¨') {
            steps {
                script {
                    echo 'ğŸ—ï¸ æ„å»ºå‰åç«¯åº”ç”¨...'

                    sh '''
                        echo "æ„å»ºå‰ç«¯..."
                        npm run build

                        echo "æ£€æŸ¥æ„å»ºäº§ç‰©..."
                        if [ ! -d "dist" ]; then
                            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼Œdist ç›®å½•ä¸å­˜åœ¨"
                            exit 1
                        fi

                        echo "æ„å»ºäº§ç‰©å¤§å°:"
                        du -sh dist/

                        echo "æ„å»ºåç«¯ TypeScript..."
                        npm run server:build || echo "âš ï¸ åç«¯æ„å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œå°†åœ¨ Docker ä¸­æ„å»º"

                        echo "âœ… åº”ç”¨æ„å»ºå®Œæˆ"
                    '''
                }
            }
        }

        stage('æ„å»º Docker é•œåƒ') {
            steps {
                script {
                    echo 'ğŸ³ æ„å»º Docker é•œåƒ...'

                    sh '''
                        # æ£€æŸ¥ Dockerfile
                        DOCKERFILE_PATH="deployment/Dockerfile"
                        if [ ! -f "$DOCKERFILE_PATH" ]; then
                            DOCKERFILE_PATH="Dockerfile"
                        fi

                        if [ ! -f "$DOCKERFILE_PATH" ]; then
                            echo "âŒ æœªæ‰¾åˆ° Dockerfile"
                            exit 1
                        fi

                        echo "ä½¿ç”¨ Dockerfile: $DOCKERFILE_PATH"

                        # æ„å»ºé•œåƒ
                        echo "æ„å»º Docker é•œåƒ: ${IMAGE_TAG}"
                        docker build -f $DOCKERFILE_PATH -t ${IMAGE_TAG} .

                        # æ ‡è®°ä¸º latestï¼ˆå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰
                        if [ "${ENVIRONMENT}" = "production" ]; then
                            docker tag ${IMAGE_TAG} ${IMAGE_NAME}:latest
                            echo "å·²æ ‡è®°ä¸º latest ç‰ˆæœ¬"
                        fi

                        # æ˜¾ç¤ºé•œåƒä¿¡æ¯
                        echo "é•œåƒæ„å»ºå®Œæˆ:"
                        docker images | grep ${APP_NAME}

                        # æ£€æŸ¥é•œåƒå¤§å°
                        IMAGE_SIZE=$(docker images --format "table {{.Size}}" ${IMAGE_TAG} | tail -n 1)
                        echo "é•œåƒå¤§å°: $IMAGE_SIZE"

                        echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"
                    '''
                }
            }
        }

        stage('é•œåƒå®‰å…¨æ‰«æ') {
            when {
                environment name: 'ENVIRONMENT', value: 'production'
            }
            steps {
                script {
                    echo 'ğŸ”’ é•œåƒå®‰å…¨æ‰«æ...'

                    sh '''
                        # ä½¿ç”¨ Trivy è¿›è¡Œå®‰å…¨æ‰«æï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        if command -v trivy >/dev/null 2>&1; then
                            echo "ä½¿ç”¨ Trivy è¿›è¡Œå®‰å…¨æ‰«æ..."
                            trivy image --exit-code 0 --severity HIGH,CRITICAL ${IMAGE_TAG}
                        else
                            echo "âš ï¸ Trivy æœªå®‰è£…ï¼Œè·³è¿‡å®‰å…¨æ‰«æ"
                        fi

                        # ä½¿ç”¨ Docker Scout æ‰«æï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        if docker scout version >/dev/null 2>&1; then
                            echo "ä½¿ç”¨ Docker Scout è¿›è¡Œå®‰å…¨æ‰«æ..."
                            docker scout cves ${IMAGE_TAG} || true
                        else
                            echo "âš ï¸ Docker Scout æœªå¯ç”¨ï¼Œè·³è¿‡æ‰«æ"
                        fi
                    '''
                }
            }
        }

        stage('æ¨é€é•œåƒ') {
            steps {
                script {
                    echo 'ğŸ“¤ æ¨é€ Docker é•œåƒåˆ°ä»“åº“...'

                    withCredentials([usernamePassword(
                        credentialsId: 'docker-registry-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            # ç™»å½•åˆ° Docker ä»“åº“
                            echo "ç™»å½•åˆ° Docker ä»“åº“: ${DOCKER_REGISTRY}"
                            echo $DOCKER_PASS | docker login ${DOCKER_REGISTRY} -u $DOCKER_USER --password-stdin

                            # æ¨é€é•œåƒ
                            echo "æ¨é€é•œåƒ: ${IMAGE_TAG}"
                            docker push ${IMAGE_TAG}

                            # æ¨é€ latest æ ‡ç­¾ï¼ˆå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰
                            if [ "${ENVIRONMENT}" = "production" ]; then
                                echo "æ¨é€ latest é•œåƒ..."
                                docker push ${IMAGE_NAME}:latest
                            fi

                            echo "âœ… é•œåƒæ¨é€å®Œæˆ"
                        '''
                    }
                }
            }
        }

        stage('å‡†å¤‡éƒ¨ç½²é…ç½®') {
            steps {
                script {
                    echo 'âš™ï¸ å‡†å¤‡éƒ¨ç½²é…ç½®æ–‡ä»¶...'

                    sh '''
                        # åˆ›å»ºéƒ¨ç½²ç›®å½•
                        mkdir -p deployment-configs

                        # å¤åˆ¶ç¯å¢ƒç‰¹å®šçš„é…ç½®
                        if [ -f "deployment/.env.${ENVIRONMENT}" ]; then
                            cp "deployment/.env.${ENVIRONMENT}" deployment-configs/.env
                            echo "ä½¿ç”¨ç¯å¢ƒç‰¹å®šé…ç½®: .env.${ENVIRONMENT}"
                        elif [ -f "deployment/.env.example" ]; then
                            cp "deployment/.env.example" deployment-configs/.env
                            echo "ä½¿ç”¨ç¤ºä¾‹é…ç½®æ–‡ä»¶"
                        else
                            echo "âš ï¸ æœªæ‰¾åˆ°ç¯å¢ƒé…ç½®æ–‡ä»¶"
                        fi

                        # å¤åˆ¶ Docker Compose é…ç½®
                        if [ -f "deployment/docker-compose.${ENVIRONMENT}.yml" ]; then
                            cp "deployment/docker-compose.${ENVIRONMENT}.yml" deployment-configs/docker-compose.yml
                            echo "ä½¿ç”¨ç¯å¢ƒç‰¹å®š Compose é…ç½®"
                        elif [ -f "deployment/docker-compose.prod.yml" ]; then
                            cp "deployment/docker-compose.prod.yml" deployment-configs/docker-compose.yml
                            echo "ä½¿ç”¨ç”Ÿäº§ Compose é…ç½®"
                        elif [ -f "deployment/docker-compose.yml" ]; then
                            cp "deployment/docker-compose.yml" deployment-configs/docker-compose.yml
                            echo "ä½¿ç”¨é»˜è®¤ Compose é…ç½®"
                        else
                            echo "âŒ æœªæ‰¾åˆ° Docker Compose é…ç½®æ–‡ä»¶"
                            exit 1
                        fi

                        # æ›¿æ¢é…ç½®ä¸­çš„å˜é‡
                        sed -i "s|{{IMAGE_TAG}}|${IMAGE_TAG}|g" deployment-configs/docker-compose.yml
                        sed -i "s|{{ENVIRONMENT}}|${ENVIRONMENT}|g" deployment-configs/docker-compose.yml
                        sed -i "s|{{COMPOSE_PROJECT_NAME}}|${COMPOSE_PROJECT_NAME}|g" deployment-configs/docker-compose.yml

                        echo "éƒ¨ç½²é…ç½®å‡†å¤‡å®Œæˆ"
                    '''
                }
            }
        }

        stage('éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨') {
            steps {
                script {
                    echo "ğŸš€ éƒ¨ç½²åˆ° ${params.ENVIRONMENT} ç¯å¢ƒ..."

                    sshagent(['deploy-ssh-key']) {
                        sh '''
                            # å¤åˆ¶éƒ¨ç½²æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨
                            echo "å¤åˆ¶éƒ¨ç½²æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨..."
                            scp -o StrictHostKeyChecking=no -r deployment-configs/* ${DEPLOY_USER}@${DEPLOY_HOST}:/opt/${APP_NAME}/
                            scp -o StrictHostKeyChecking=no scripts/deploy.sh ${DEPLOY_USER}@${DEPLOY_HOST}:/opt/${APP_NAME}/
                            scp -o StrictHostKeyChecking=no scripts/health-check.sh ${DEPLOY_USER}@${DEPLOY_HOST}:/opt/${APP_NAME}/

                            # åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²
                            echo "åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
                            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "
                                cd /opt/${APP_NAME}
                                chmod +x deploy.sh health-check.sh
                                ./deploy.sh ${ENVIRONMENT} ${DEPLOY_STRATEGY} ${IMAGE_TAG}
                            "
                        '''
                    }
                }
            }
        }

        stage('å¥åº·æ£€æŸ¥') {
            steps {
                script {
                    echo 'ğŸ¥ æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥...'

                    sshagent(['deploy-ssh-key']) {
                        sh '''
                            # ç­‰å¾…æœåŠ¡å¯åŠ¨
                            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                            sleep 30

                            # æ‰§è¡Œå¥åº·æ£€æŸ¥
                            echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
                            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "
                                cd /opt/${APP_NAME}
                                ./health-check.sh ${ENVIRONMENT}
                            "
                        '''
                    }
                }
            }
        }

        stage('çƒŸé›¾æµ‹è¯•') {
            steps {
                script {
                    echo 'ğŸ’¨ æ‰§è¡ŒçƒŸé›¾æµ‹è¯•...'

                    sh '''
                        # è·å–åº”ç”¨ URL
                        case "${ENVIRONMENT}" in
                            "production")
                                APP_URL="https://automation-platform.example.com"
                                ;;
                            "staging")
                                APP_URL="https://staging-automation-platform.example.com"
                                ;;
                            "dev")
                                APP_URL="https://dev-automation-platform.example.com"
                                ;;
                            *)
                                APP_URL="http://${DEPLOY_HOST}:3000"
                                ;;
                        esac

                        echo "æµ‹è¯•åº”ç”¨ URL: $APP_URL"

                        # å¥åº·æ£€æŸ¥ç«¯ç‚¹æµ‹è¯•
                        echo "æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹..."
                        curl -f "$APP_URL/api/health" || {
                            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                            exit 1
                        }

                        # API ç«¯ç‚¹æµ‹è¯•
                        echo "æµ‹è¯• API ç«¯ç‚¹..."
                        curl -f "$APP_URL/api/dashboard" -H "Content-Type: application/json" || {
                            echo "âš ï¸ API ç«¯ç‚¹æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²"
                        }

                        # å‰ç«¯é¡µé¢æµ‹è¯•
                        echo "æµ‹è¯•å‰ç«¯é¡µé¢..."
                        curl -f "$APP_URL/" || {
                            echo "âŒ å‰ç«¯é¡µé¢è®¿é—®å¤±è´¥"
                            exit 1
                        }

                        echo "âœ… çƒŸé›¾æµ‹è¯•é€šè¿‡"
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                echo 'ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ...'

                // æ¸…ç†æœ¬åœ° Docker é•œåƒ
                sh '''
                    echo "æ¸…ç†æœ¬åœ° Docker é•œåƒ..."
                    docker rmi ${IMAGE_TAG} || true
                    if [ "${ENVIRONMENT}" = "production" ]; then
                        docker rmi ${IMAGE_NAME}:latest || true
                    fi

                    # æ¸…ç†æœªä½¿ç”¨çš„ Docker èµ„æº
                    docker image prune -f || true
                '''

                // å½’æ¡£æ„å»ºäº§ç‰©
                archiveArtifacts artifacts: 'dist/**', allowEmptyArchive: true
                archiveArtifacts artifacts: 'deployment-configs/**', allowEmptyArchive: true
            }
        }

        success {
            script {
                echo """
                âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼

                ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:
                - ç¯å¢ƒ: ${params.ENVIRONMENT}
                - ç‰ˆæœ¬: ${BUILD_VERSION}
                - é•œåƒ: ${IMAGE_TAG}
                - ç­–ç•¥: ${params.DEPLOY_STRATEGY}

                ğŸ”— è®¿é—®é“¾æ¥:
                - å¥åº·æ£€æŸ¥: http://${env.DEPLOY_HOST}:3000/api/health
                - åº”ç”¨é¦–é¡µ: http://${env.DEPLOY_HOST}:3000/
                """

                // å‘é€æˆåŠŸé€šçŸ¥
                emailext(
                    subject: "âœ… [${APP_NAME}] éƒ¨ç½²æˆåŠŸ - ${params.ENVIRONMENT} ç¯å¢ƒ",
                    body: """
                    éƒ¨ç½²å·²æˆåŠŸå®Œæˆï¼

                    ç¯å¢ƒ: ${params.ENVIRONMENT}
                    ç‰ˆæœ¬: ${BUILD_VERSION}
                    æ„å»ºå·: ${BUILD_NUMBER}
                    éƒ¨ç½²æ—¶é—´: ${new Date()}

                    æ„å»ºæ—¥å¿—: ${BUILD_URL}
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL ?: 'devops@example.com'}"
                )
            }
        }

        failure {
            script {
                echo """
                âŒ éƒ¨ç½²å¤±è´¥ï¼

                ğŸ“‹ å¤±è´¥ä¿¡æ¯:
                - ç¯å¢ƒ: ${params.ENVIRONMENT}
                - ç‰ˆæœ¬: ${BUILD_VERSION}
                - é˜¶æ®µ: ${env.STAGE_NAME}
                """

                // è‡ªåŠ¨å›æ»šï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼‰
                if (params.DEPLOY_STRATEGY == 'blue-green') {
                    echo 'ğŸ”„ å°è¯•è‡ªåŠ¨å›æ»š...'

                    sshagent(['deploy-ssh-key']) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "
                                cd /opt/${APP_NAME}
                                ./rollback.sh ${ENVIRONMENT}
                            " || echo "è‡ªåŠ¨å›æ»šå¤±è´¥"
                        '''
                    }
                }

                // å‘é€å¤±è´¥é€šçŸ¥
                emailext(
                    subject: "âŒ [${APP_NAME}] éƒ¨ç½²å¤±è´¥ - ${params.ENVIRONMENT} ç¯å¢ƒ",
                    body: """
                    éƒ¨ç½²å¤±è´¥ï¼

                    ç¯å¢ƒ: ${params.ENVIRONMENT}
                    ç‰ˆæœ¬: ${BUILD_VERSION}
                    æ„å»ºå·: ${BUILD_NUMBER}
                    å¤±è´¥æ—¶é—´: ${new Date()}
                    å¤±è´¥é˜¶æ®µ: ${env.STAGE_NAME}

                    æ„å»ºæ—¥å¿—: ${BUILD_URL}

                    è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL ?: 'devops@example.com'}"
                )
            }
        }

        aborted {
            script {
                echo 'â¹ï¸ éƒ¨ç½²è¢«ä¸­æ­¢'

                emailext(
                    subject: "â¹ï¸ [${APP_NAME}] éƒ¨ç½²ä¸­æ­¢ - ${params.ENVIRONMENT} ç¯å¢ƒ",
                    body: """
                    éƒ¨ç½²è¢«æ‰‹åŠ¨ä¸­æ­¢ã€‚

                    ç¯å¢ƒ: ${params.ENVIRONMENT}
                    ç‰ˆæœ¬: ${BUILD_VERSION}
                    æ„å»ºå·: ${BUILD_NUMBER}
                    ä¸­æ­¢æ—¶é—´: ${new Date()}

                    æ„å»ºæ—¥å¿—: ${BUILD_URL}
                    """,
                    to: "${env.CHANGE_AUTHOR_EMAIL ?: 'devops@example.com'}"
                )
            }
        }
    }
}